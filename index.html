<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flight Cost Calculator v5.0</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  label {
    display: block;
    margin: 10px 0 5px;
  }
  input, select {
    padding: 8px;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
  }
  button {
    padding: 10px 15px;
    margin-top: 10px;
    cursor: pointer;
  }
  table {
    margin-top: 20px;
    border-collapse: collapse;
    width: 100%;
    max-width: 1200px;
    overflow-x: auto;
    display: block;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    white-space: nowrap;
  }
  th {
    background-color: #f5f5f5;
  }
  tfoot {
    font-weight: bold;
  }
  .warning {
    color: red;
    font-weight: bold;
  }
  #result p strong {
    display: inline-block;
    min-width: 170px;
  }
  #map {
    height: 400px;
    max-width: 900px;
    margin-top: 20px;
  }
  #footer {
    margin-top: 30px;
    font-size: 0.9em;
    color: #666;
    text-align: center;
  }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    body {
      margin: 10px;
      font-size: 14px;
    }
    table {
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    th, td {
      white-space: normal;
      padding: 6px 4px;
    }
    input, button {
      max-width: 100%;
      font-size: 14px;
      padding: 10px 8px;
    }
    label {
      font-size: 14px;
    }
  }

  @media (min-width: 601px) and (max-width: 900px) {
    body {
      font-size: 16px;
    }
    input, button {
      max-width: 400px;
    }
  }

  @media (min-width: 901px) {
    body {
      font-size: 18px;
    }
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

</head>
<body>

<h1>Multi-Leg Flight Cost Calculator v5.0</h1>

<label for="route">Route (e.g. JFK-ORD-LAX-MEX):</label>
<input type="text" id="route" placeholder="Enter multi-leg route, e.g. JFK-ORD-LAX-MEX" />

<label for="aircraft">Aircraft Code (e.g. B738, A320):</label>
<input type="text" id="aircraft" maxlength="5" placeholder="e.g. B738" />

<div id="fuelPriceContainer">
  <label for="fuelPrice">Fuel Price (USD/kg):</label>
  <input type="number" id="fuelPrice" step="0.01" value="1.07" />
</div>

<div id="acmiRateContainer">
  <label for="acmiRate">ACMI Hourly Rate (USD):</label>
  <input type="number" id="acmiRate" step="10" />
</div>

<label for="navRate">Air Navigation Fee Rate (USD/NM):</label>
<input type="number" id="navRate" step="0.1" value="4" />

<button id="calculateBtn" onclick="calculateFlight()">Calculate</button>
<button id="queryAgainBtn" onclick="resetApp()" style="display:none; margin-top: 20px;">Query Again</button>

<div id="result"></div>
<div id="map"></div>

<div id="footer">© Aerohub Version 5.0 27 Oct 2025</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let aircraftInfo = {};

  fetch('aircraftData.json')
    .then(response => response.json())
    .then(data => aircraftInfo = data.aircraft)
    .catch(err => alert("Error loading aircraft data: " + err.message));

  const fixedBlockMinutes = 30;
  const baseFuelPrice = 1.07;

  let map;
  let routeLayer;

  function formatNumber(num) {
    return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
  }

  function formatFlightTime(hours) {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return `${h} hr ${m} min`;
  }

  async function fetchDistanceWithCoords(origin, destination) {
    const response = await fetch('https://airportgap.com/api/airports/distance', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer token=iHPosKuEeLi2rJHtUNxNJtKo'
      },
      body: JSON.stringify({ from: origin.toUpperCase(), to: destination.toUpperCase() })
    });
    if (!response.ok) throw new Error('API error: ' + response.statusText);
    return response.json();
  }

  async function calculateFlight() {
    const routeInput = document.getElementById('route').value.trim().toUpperCase();
    const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();

    if (!aircraftInfo[aircraftCode]) {
      alert('Aircraft code not found in database.');
      return;
    }
    const aircraft = aircraftInfo[aircraftCode];

    const fuelPricePerKg = parseFloat(document.getElementById('fuelPrice').value) || baseFuelPrice;
    const acmiRate = parseFloat(document.getElementById('acmiRate').value) || aircraft.acmiRate;
    const navRate = parseFloat(document.getElementById('navRate').value);

    const airports = routeInput.split('-');
    if (airports.length < 2) { alert('Enter at least two airports.'); return; }

    let totalNM = 0, totalFlightTime = 0, totalBlockTime = 0, totalFuelBurn = 0;
    let totalFuelCost = 0, totalAcmiCost = 0, totalNavCharge = 0;
    let warningFlag = false;

    if(routeLayer) routeLayer.clearLayers();
    if(!map) {
      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution: '© OpenStreetMap'}).addTo(map);
    }
    let latlngs = [];
    let flightData = [], costData = [], airportData = [];

    for(let i=0; i<airports.length-1; i++) {
      const fromCode = airports[i];
      const toCode = airports[i+1];
      try {
        const data = await fetchDistanceWithCoords(fromCode, toCode);
        const attr = data.data.attributes;
        const nm = attr.nautical_miles;
        const flightTimeHrs = nm / aircraft.speed;
        const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;
        const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;
        const fuelCost = fuelBurnKg * fuelPricePerKg;
        const acmiCost = blockTimeHrs * acmiRate;
        const navCharge = nm * Math.pow(aircraft.maxTakeoffWeightKg/1000 / 50, 0.7) * navRate;

        totalNM += nm;
        totalFlightTime += flightTimeHrs;
        totalBlockTime += blockTimeHrs;
        totalFuelBurn += fuelBurnKg;
        totalFuelCost += fuelCost;
        totalAcmiCost += acmiCost;
        totalNavCharge += navCharge;

        if (nm > aircraft.maxRangeNM) warningFlag = true;

        latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
        if(i === airports.length-2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);

        flightData.push({from: fromCode, to: toCode, nm, flightTimeHrs, blockTimeHrs, fuelBurnKg});
        costData.push({from: fromCode, to: toCode, fuelCost, acmiCost, navCharge, total: fuelCost+acmiCost+navCharge});
        airportData.push({code: attr.from_airport.iata, name: attr.from_airport.name, country: attr.from_airport.country});
        if(i === airports.length-2) airportData.push({code: attr.to_airport.iata, name: attr.to_airport.name, country: attr.to_airport.country});
      } catch(e) {
        alert(`Error fetching data for leg ${fromCode} to ${toCode}: ${e.message}`);
        return;
      }
    }

    let resultHTML = '';

    // Flight Data Table
    resultHTML += `<h2>Flight Data</h2><table><thead><tr>
      <th>From</th><th>To</th><th>Distance (NM)</th><th>Flight Time</th><th>Block Time</th><th>Fuel Burn (kg)</th>
    </tr></thead><tbody>`;
    flightData.forEach(d => {
      resultHTML += `<tr>
        <td>${d.from}</td><td>${d.to}</td><td>${formatNumber(d.nm)}</td>
        <td>${formatFlightTime(d.flightTimeHrs)}</td><td>${formatFlightTime(d.blockTimeHrs)}</td>
        <td>${formatNumber(d.fuelBurnKg)}</td>
      </tr>`;
    });
    resultHTML += `<tfoot><tr>
      <td colspan="2">Total</td>
      <td>${formatNumber(totalNM)}</td>
      <td>${formatFlightTime(totalFlightTime)}</td>
      <td>${formatFlightTime(totalBlockTime)}</td>
      <td>${formatNumber(totalFuelBurn)}</td>
    </tr></tfoot></table>`;

    // Cost Table
    resultHTML += `<h2>Cost Table</h2><table><thead><tr>
      <th>From</th><th>To</th><th>Fuel Cost (USD)</th><th>ACMI Cost (USD)</th><th>Navigation Charge (USD)</th><th>Total Cost (USD)</th>
    </tr></thead><tbody>`;
    costData.forEach(d => {
      resultHTML += `<tr>
        <td>${d.from}</td><td>${d.to}</td><td>${formatNumber(d.fuelCost)}</td>
        <td>${formatNumber(d.acmiCost)}</td><td>${formatNumber(d.navCharge)}</td><td>${formatNumber(d.total)}</td>
      </tr>`;
    });
    resultHTML += `<tfoot><tr>
      <td colspan="2">Total</td>
      <td>${formatNumber(totalFuelCost)}</td>
      <td>${formatNumber(totalAcmiCost)}</td>
      <td>${formatNumber(totalNavCharge)}</td>
      <td>${formatNumber(totalFuelCost+totalAcmiCost+totalNavCharge)}</td>
    </tr></tfoot></table>`;

    // Airports & Countries Table
    resultHTML += `<h2>Airports & Countries</h2><table><thead><tr>
      <th>Airport Code</th><th>Airport Name</th><th>Country</th>
    </tr></thead><tbody>`;
    airportData.forEach(d => {
      resultHTML += `<tr><td>${d.code}</td><td>${d.name}</td><td>${d.country}</td></tr>`;
    });
    resultHTML += `</tbody></table>`;

    // Cost Assumptions Table
    resultHTML += `<h2>Cost Assumptions</h2><table><tbody>
      <tr><td>Aircraft Type</td><td>${aircraftCode}</td></tr>
      <tr><td>Max Takeoff Weight (kg)</td><td>${formatNumber(aircraft.maxTakeoffWeightKg)}</td></tr>
      <tr><td>Fuel Burn per Hour (kg/hr)</td><td>${formatNumber(aircraft.fuelBurnKgPerHr)}</td></tr>
      <tr><td>Fuel Price (USD/kg)</td><td>${fuelPricePerKg}</td></tr>
      <tr><td>ACMI Hourly Rate (USD)</td><td>${formatNumber(acmiRate)}</td></tr>
      <tr><td>Air Navigation Fee Rate (USD/NM)</td><td>${formatNumber(navRate)}</td></tr>
      <tr><td>Block Time Adjustment (min)</td><td>${fixedBlockMinutes}</td></tr>
      <tr><td>Aircraft Max Range (NM)</td><td>${formatNumber(aircraft.maxRangeNM)}</td></tr>
      <tr><td>Warning</td><td>${warningFlag ? 'One or more legs exceed max range!' : 'No'}</td></tr>
    </tbody></table>`;

    document.getElementById('result').innerHTML = resultHTML;

    // Map
    routeLayer = L.polyline(latlngs, {color: 'blue'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
    latlngs.forEach((latlng, idx) => {
      L.marker(latlng).addTo(map).bindPopup(airports[idx]).openPopup();
    });

    document.getElementById('route').disabled = true;
    document.getElementById('aircraft').disabled = true;
    document.getElementById('fuelPrice').disabled = true;
    document.getElementById('acmiRate').disabled = true;
    document.getElementById('navRate').disabled = true;
    document.getElementById('calculateBtn').style.display = 'none';
    document.getElementById('queryAgainBtn').style.display = 'inline-block';
  }

  function resetApp() {
    document.getElementById('result').innerHTML = '';
    document.getElementById('route').disabled = false;
    document.getElementById('aircraft').disabled = false;
    document.getElementById('fuelPrice').disabled = false;
    document.getElementById('acmiRate').disabled = false;
    document.getElementById('navRate').disabled = false;
    document.getElementById('calculateBtn').style.display = 'inline-block';
    document.getElementById('queryAgainBtn').style.display = 'none';
    if(routeLayer) routeLayer.clearLayers();
  }
</script>
</body>
</html>
