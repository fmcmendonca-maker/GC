<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flight Cost Calculator with Tables</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin: 10px 0 5px; }
  input, select { padding: 8px; width: 100%; max-width: 400px; }
  button { padding: 10px 15px; margin-top: 10px; }
  table { margin-top: 10px; border-collapse: collapse; width: 100%; max-width: 1200px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; white-space: nowrap; }
  th { background-color: #f5f5f5; }
  .warning { color: red; font-weight: bold; }
  #map { height: 400px; max-width: 900px; margin-top: 20px; }
  #footer { margin-top: 30px; font-size: 0.9em; color: #666; text-align: center; }
  h2 { margin-top: 30px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<h1>Multi-Leg Flight Distance & Cost Calculator</h1>

<label for="route">V11 Route (e.g. JFK-ORD-LAX):</label>
<input type="text" id="route" placeholder="Enter multi-leg route, e.g., FRA-LIS-MAD" />

<label for="aircraft">Aircraft Code (e.g. B738, A320):</label>
<input type="text" id="aircraft" maxlength="5" placeholder="e.g. B738" />

<div id="fuelPriceContainer" style="display:none;">
  <label for="fuelPrice">Fuel Price (USD/kg):</label>
  <input type="number" id="fuelPrice" step="0.01" value="1.07" />
</div>
<div id="infoBasePrice">
  Using base fuel price <strong>$1.07 USD/kg</strong> from 
  <a href="https://www.iata.org/en/publications/economics/fuel-monitor/" target="_blank" rel="noopener">IATA Jet Fuel Price Monitor</a> (Oct 2025).
  <span id="toggleFuelPriceBtn" onclick="toggleFuelInput()" style="color:blue; cursor:pointer;">Change</span>
</div>

<div id="acmiRateContainer" style="display:none;">
  <label for="acmiRate">ACMI Hourly Rate (USD):</label>
  <input type="number" id="acmiRate" step="10" />
</div>
<div id="infoBaseAcmi">
  Using default ACMI hourly rates by aircraft type (editable).
  <span id="toggleAcmiRateBtn" onclick="toggleAcmiInput()" style="color:blue; cursor:pointer;">Change</span>
</div>

<label for="navRate">Air Navigation Fee Rate (USD/NM):</label>
<input type="number" id="navRate" step="0.1" value="4.0" />

<button id="calculateBtn" onclick="calculateFlight()">Calculate</button>

<div id="flightData"></div>
<div id="costData"></div>
<div id="airportData"></div>

<div id="map"></div>

<button id="queryAgainBtn" onclick="location.reload()" style="display:none; margin-top: 20px;">Query Again</button>

<div id="footer">© Aerohub   Version 4.02   Oct2025 NavCharges V2</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  let aircraftInfo = {};

  fetch('aircraftData.json')
    .then(response => response.json())
    .then(data => aircraftInfo = data.aircraft)
    .catch(err => alert("Error loading aircraft data: " + err.message));

  const fixedBlockMinutes = 30;
  const baseFuelPrice = 1.07;
  let useBaseFuelPrice = true;
  let useDefaultAcmiRate = true;

  function toggleFuelInput(){
    const container = document.getElementById('fuelPriceContainer');
    const info = document.getElementById('infoBasePrice');
    if(container.style.display === 'none'){
      container.style.display = 'block';
      info.style.display = 'none';
      document.getElementById('fuelPrice').value = baseFuelPrice.toFixed(2);
      useBaseFuelPrice = false;
    } else {
      container.style.display = 'none';
      info.style.display = 'block';
      useBaseFuelPrice = true;
    }
  }

  // Navigation Charges Data Structure

  const navChargesData = {
    regions: {
        EUR: {
            baseRate: 85,
            countries: ['FR', 'DE', 'GB', 'IT', 'ES', 'PT', 'CH', 'AT', 'BE', 'NL', 'DK', 'NO', 'SE', 'FI']
        },
        NAM: {
            baseRate: 35,
            countries: ['US', 'CA']
        },
        ASIA: {
            baseRate: 55,
            countries: ['CN', 'JP', 'KR', 'SG', 'TH', 'MY', 'ID', 'IN', 'PH', 'VN']
        },
        MEA: {
            baseRate: 65,
            countries: ['AE', 'SA', 'QA', 'BH', 'OM', 'KW']
        },
        AFR: {
            baseRate: 45,
            countries: ['ZA', 'EG', 'MA', 'NG', 'KE', 'ET']
        },
        SAM: {
            baseRate: 40,
            countries: ['BR', 'AR', 'CL', 'CO', 'PE', 'VE']
        },
        OCE: {
            baseRate: 50,
            countries: ['AU', 'NZ', 'FJ', 'PG']
        }
    },
    countryRates: {
        'CH': 95,
        'GB': 80,
        'SG': 65,
        'JP': 70
    }
};

// Navigation Charge Calculation Function
function calculateNavCharges(fromCountry, toCountry, nm, mtowTons) {
    // Determine regions
    let fromRegion = 'OTHER';
    let toRegion = 'OTHER';
    
    // Find regions for both countries
    for (const [region, data] of Object.entries(navChargesData.regions)) {
        if (data.countries.includes(fromCountry)) fromRegion = region;
        if (data.countries.includes(toCountry)) toRegion = region;
    }

    // Get rates (use country-specific rates if available, otherwise use region rates)
    const fromRate = navChargesData.countryRates[fromCountry] || 
                    navChargesData.regions[fromRegion]?.baseRate || 45;
    const toRate = navChargesData.countryRates[toCountry] || 
                  navChargesData.regions[toRegion]?.baseRate || 45;

    // Calculate average rate for the route
    const averageRate = (fromRate + toRate) / 2;

    // Calculate weight factor using Eurocontrol formula
    const weightFactor = Math.sqrt(mtowTons / 50);

    // Calculate distance factor (per 100 NM)
    const distanceFactor = nm / 100;

    // Calculate final charge
    return distanceFactor * weightFactor * averageRate;
}

// Modified calculateFlight function
async function calculateFlight() {
    try {
        // ... existing input validation code ...

        const legsData = [];
        let warningFlag = false;
        let latlngs = [];

        // Initialize map
        if(map) map.remove();
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // Calculate each leg
        for(let i = 0; i < airports.length - 1; i++) {
            const fromCode = airports[i];
            const toCode = airports[i+1];
            
            try {
                const data = await fetchDistanceWithCoords(fromCode, toCode);
                if (!data?.data?.attributes) {
                    throw new Error('Invalid API response structure');
                }
                
                const attr = data.data.attributes;
                const nm = attr.nautical_miles;
                const flightTimeHrs = nm / aircraft.speed;
                const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;
                const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;
                const fuelCost = fuelBurnKg * fuelPricePerKg;
                const acmiCost = blockTimeHrs * acmiRate;
                
                // Calculate navigation charges using the new function
                const navCharge = calculateNavCharges(
                    attr.from_airport.country,
                    attr.to_airport.country,
                    nm,
                    mtowTons
                );

                if (nm > aircraft.maxRangeNM) warningFlag = true;

                // Add leg data
                legsData.push({
                    from: fromCode,
                    to: toCode,
                    distanceNM: nm,
                    flightTimeHrs,
                    blockTimeHrs,
                    fuelBurnKg,
                    fuelCost,
                    acmiCost,
                    navCharge,
                    fromCountry: attr.from_airport.country,
                    toCountry: attr.to_airport.country,
                    fromAirportName: attr.from_airport.name,
                    toAirportName: attr.to_airport.name,
                    fromAirportCity: attr.from_airport.city || '',
                    toAirportCity: attr.to_airport.city || ''
                });

                // Add coordinates for map
                latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
                if(i === airports.length - 2) {
                    latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);
                }

            } catch(error) {
                console.error(`Error calculating leg ${fromCode}-${toCode}:`, error);
                throw new Error(`Error calculating leg ${fromCode} to ${toCode}: ${error.message}`);
            }
        }

        // ... existing totals calculation and display code ...

    } catch(error) {
        console.error('Calculation error:', error);
        alert('Error calculating flight: ' + error.message);
    }
}


// Main calculation function Calculate flight details and costs

console.log('Calculate button clicked');

  async function calculateFlight() {
    const routeInput = document.getElementById('route').value.trim().toUpperCase();
    const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();

    if (!isValidAircraftCode(aircraftCode)) {
      alert('Please enter a valid aircraft code (3-4 uppercase letters/digits, e.g., B738)');
      return;
    }

    if (!aircraftInfo[aircraftCode]) {
      alert('Aircraft code not found in database.');
      return;
    }

    const airports = routeInput.split('-');
    if (airports.length < 2) {
      alert('Please enter at least two airports separated by hyphens.');
      return;
    }
    for (const code of airports) {
      if (code.length !== 3) {
        alert('Each airport must be a 3-letter IATA code.');
        return;
      }
    }

    let fuelPricePerKg = baseFuelPrice;
    if(!useBaseFuelPrice){
      fuelPricePerKg = parseFloat(document.getElementById('fuelPrice').value);
      if(isNaN(fuelPricePerKg) || fuelPricePerKg <= 0){
        alert('Please enter a valid fuel price per kg.');
        return;
      }
    }

    let acmiRate = aircraftInfo[aircraftCode] ? aircraftInfo[aircraftCode].acmiRate : 4000;
    if(!useDefaultAcmiRate){
      acmiRate = parseFloat(document.getElementById('acmiRate').value);
      if (isNaN(acmiRate) || acmiRate <= 0) {
        alert('Please enter a valid ACMI hourly rate.');
        return;
      }
    }

    const navRate = parseFloat(document.getElementById('navRate').value);
    if (isNaN(navRate) || navRate <= 0) {
      alert('Please enter a valid Air Navigation Fee Rate (USD/NM).');
      return;
    }

    const aircraft = aircraftInfo[aircraftCode];
    const mtowKg = aircraft.maxTakeoffWeightKg;
    if (typeof mtowKg !== 'number' || mtowKg <= 0) {
      alert('Invalid MTOW set for this aircraft.');
      return;
    }
    const mtowTons = mtowKg / 1000;

    const legsData = [];
    let warningFlag = false;
    let latlngs = [];

console.log(`Calculating leg: ${fromCode} to ${toCode}`);

// Add error handling:
try {
    const data = await fetchDistanceWithCoords(fromCode, toCode);
    if (!data || !data.data || !data.data.attributes) {
        console.error('Invalid API response:', data);
        throw new Error('Invalid API response structure');
    }
    const attr = data.data.attributes;
    console.log('API response:', attr);
    
    // ... rest of the calculation code ...
    
} catch (error) {
    console.error('Error:', error);
    alert(`Error calculating flight: ${error.message}`);
    return;
}


    if(map) map.remove();
    map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution: '© OpenStreetMap'}).addTo(map);

    for(let i = 0; i < airports.length -1; i++) {
      const fromCode = airports[i];
      const toCode = airports[i+1];
      try {
        const data = await fetchDistanceWithCoords(fromCode, toCode);
        const attr = data.data.attributes;

        const nm = attr.nautical_miles;
        const flightTimeHrs = nm / aircraft.speed;
        const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;
        const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;
        const fuelCost = fuelBurnKg * fuelPricePerKg;
        const acmiCost = blockTimeHrs * acmiRate;
        const navCharge = calculateNavCharges(
              attr.from_airport.country,
              attr.to_airport.country,
              nm,
              mtowTons
          );

        if (nm > aircraft.maxRangeNM) warningFlag = true;

        legsData.push({
          from: fromCode,
          to: toCode,
          distanceNM: nm,
          flightTimeHrs,
          blockTimeHrs,
          fuelBurnKg,
          fuelCost,
          acmiCost,
          navCharge,
          fromCountry: attr.from_airport.country,
          toCountry: attr.to_airport.country,
          fromAirportName: attr.from_airport.name,
          toAirportName: attr.to_airport.name,
          fromAirportCity: attr.from_airport.city || '',
          toAirportCity: attr.to_airport.city || ''
        });

        latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
        if(i === airports.length - 2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);
      } catch(e) {
        alert(`Error fetching data for leg ${fromCode} to ${toCode}: ${e.message}`);
        return;
      }
    }

    const totals = {
      distanceNM: 0, flightTimeHrs: 0, blockTimeHrs: 0,
      fuelBurnKg: 0, fuelCostUSD: 0, acmiCostUSD: 0, navChargeUSD: 0
    };
    legsData.forEach(leg => {
      totals.distanceNM += leg.distanceNM;
      totals.flightTimeHrs += leg.flightTimeHrs;
      totals.blockTimeHrs += leg.blockTimeHrs;
      totals.fuelBurnKg += leg.fuelBurnKg;
      totals.fuelCostUSD += leg.fuelCost;
      totals.acmiCostUSD += leg.acmiCost;
      totals.navChargeUSD += leg.navCharge;
    });
    const totalCost = totals.fuelCostUSD + totals.acmiCostUSD + totals.navChargeUSD;

    // Flight Data Table
    let flightTableHTML = `<h2>Flight Data</h2><table>
      <thead><tr>
        <th>From</th><th>To</th><th>Distance (NM)</th><th>Flight Time</th><th>Block Time</th><th>Fuel Burn (kg)</th>
      </tr></thead><tbody>`;
    legsData.forEach(leg => {
      flightTableHTML += `<tr>
        <td>${leg.from}</td>
        <td>${leg.to}</td>
        <td>${formatNumberEU(leg.distanceNM)}</td>
        <td>${formatFlightTime(leg.flightTimeHrs)}</td>
        <td>${formatFlightTime(leg.blockTimeHrs)}</td>
        <td>${formatNumberEU(leg.fuelBurnKg)}</td>
      </tr>`;
    });
    flightTableHTML += `</tbody></table>`;
    document.getElementById('flightData').innerHTML = flightTableHTML;

    // Cost Summary Table
    let costTableHTML = `<h2>Cost Summary</h2><table>
      <thead><tr>
        <th>Leg</th>
        <th>Fuel Cost (USD)</th>
        <th>ACMI Cost (USD)</th>
        <th>Navigation Charge (USD)</th>
      </tr></thead><tbody>`;
    legsData.forEach(leg => {
      costTableHTML += `<tr>
        <td>${leg.from} → ${leg.to}</td>
        <td>${formatNumberEU(leg.fuelCost)}</td>
        <td>${formatNumberEU(leg.acmiCost)}</td>
        <td>${formatNumberEU(leg.navCharge)}</td>
      </tr>`;
    });
    costTableHTML += `<tr style="font-weight:bold;">
      <td>Totals</td>
      <td>${formatNumberEU(totals.fuelCostUSD)}</td>
      <td>${formatNumberEU(totals.acmiCostUSD)}</td>
      <td>${formatNumberEU(totals.navChargeUSD)}</td>
    </tr></tbody></table>`;

    costTableHTML += `<p><strong>Total Cost (USD):</strong> ${formatNumberEU(totalCost)}</p>`;

    costTableHTML += `<p>
      Fuel Cost: ${(totals.fuelCostUSD / totalCost * 100).toFixed(0)}%<br/>
      ACMI Cost: ${(totals.acmiCostUSD / totalCost * 100).toFixed(0)}%<br/>
      Navigation Charge: ${(totals.navChargeUSD / totalCost * 100).toFixed(0)}%
    </p>`;

    document.getElementById('costData').innerHTML = costTableHTML;

    // Airport & Country Data Table
    let airportTableHTML = `<h2>Country & Airport Data</h2><table>
      <thead><tr>
        <th>Airport Code</th><th>Airport Name</th><th>City</th><th>Country</th>
      </tr></thead><tbody>`;
    legsData.forEach(leg => {
      airportTableHTML += `<tr><td>${leg.from}</td><td>${leg.fromAirportName}</td><td>${leg.fromAirportCity}</td><td>${leg.fromCountry}</td></tr>`;
      airportTableHTML += `<tr><td>${leg.to}</td><td>${leg.toAirportName}</td><td>${leg.toAirportCity}</td><td>${leg.toCountry}</td></tr>`;
    });
    airportTableHTML += `</tbody></table>`;
    document.getElementById('airportData').innerHTML = airportTableHTML;

    if(routeLayer) routeLayer.clearLayers();
    routeLayer = L.polyline(latlngs, {color: 'blue'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());

    latlngs.forEach((latlng, idx) => {
      L.marker(latlng).addTo(map).bindPopup(airports[idx]).openPopup();
    });

    if(warningFlag) {
      alert("Warning: One or more legs exceed aircraft max range!");
    }

    document.getElementById('route').disabled = true;
    document.getElementById('aircraft').disabled = true;
    document.getElementById('fuelPrice').disabled = true;
    document.getElementById('acmiRate').disabled = true;
    document.getElementById('navRate').disabled = true;
    document.getElementById('calculateBtn').style.display = 'none';
    document.getElementById('queryAgainBtn').style.display = 'inline-block';
  }
</script>
</body>
</html>
