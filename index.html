<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flight Cost Calculator v5.0</title>
<style>
  /* Your existing styles here */
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  label {
    display: block;
    margin: 10px 0 5px;
  }
  input, select {
    padding: 8px;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
  }
  button {
    padding: 10px 15px;
    margin-top: 10px;
    cursor: pointer;
  }
  table {
    margin-top: 20px;
    border-collapse: collapse;
    width: 100%;
    max-width: 1200px;
    overflow-x: auto;
    display: block;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    white-space: nowrap;
  }
  th {
    background-color: #f5f5f5;
  }
  tfoot {
    font-weight: bold;
  }
  .warning {
    color: red;
    font-weight: bold;
  }
  #result p strong {
    display: inline-block;
    min-width: 170px;
  }
  #map {
    height: 400px;
    max-width: 900px;
    margin-top: 20px;
  }
  #footer {
    margin-top: 30px;
    font-size: 0.9em;
    color: #666;
    text-align: center;
  }
  /* Responsive adjustments */
  @media (max-width: 600px) {
    body {
      margin: 10px;
      font-size: 14px;
    }
    table {
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    th, td {
      white-space: normal;
      padding: 6px 4px;
    }
    input, button {
      max-width: 100%;
      font-size: 14px;
      padding: 10px 8px;
    }
    label {
      font-size: 14px;
    }
  }
  @media (min-width: 601px) and (max-width: 900px) {
    body {
      font-size: 16px;
    }
    input, button {
      max-width: 400px;
    }
  }
  @media (min-width: 901px) {
    body {
      font-size: 18px;
    }
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<h1>Multi-Leg Flight Cost Calculator v5.0</h1>

<label for="route">Route (e.g. JFK-ORD-LAX-MEX):</label>
<input type="text" id="route" placeholder="Enter multi-leg route, e.g. JFK-ORD-LAX-MEX" />

<label for="aircraft">Aircraft Code (e.g. B738, A320):</label>
<input type="text" id="aircraft" maxlength="5" placeholder="e.g. B738" />

<div id="fuelPriceContainer">
  <label for="fuelPrice">Fuel Price (USD/kg):</label>
  <input type="number" id="fuelPrice" step="0.01" value="1.07" />
</div>

<div id="acmiRateContainer">
  <label for="acmiRate">ACMI Hourly Rate (USD):</label>
  <input type="number" id="acmiRate" step="10" />
</div>

<label for="navRate">Air Navigation Fee Rate (USD/NM):</label>
<input type="number" id="navRate" step="0.1" value="4" />

<button id="calculateBtn" onclick="calculateFlight()">Calculate</button>
<button id="queryAgainBtn" onclick="resetApp()" style="display:none; margin-top: 20px;">Query Again</button>

<div id="result"></div>
<div id="analytics">
  <h2>Analytics</h2>
  <canvas id="analyticsChart" style="max-width:600px;"></canvas>
  <div id="analyticsText" style="margin-top: 10px; font-size: 1.1em;"></div>
</div>

<div id="map"></div>

<div id="footer">© Aerohub Version 5.0 27 Oct 2025</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let aircraftInfo = {};

  // Load your aircraft data - simulate or fetch your JSON here
  aircraftInfo = {
    B738: {
      speed: 450, // nm/hr approx
      maxTakeoffWeightKg: 79015,
      fuelBurnKgPerHr: 2600,
      maxRangeNM: 2935,
      acmiRate: 1800,
      seats: 160
    }
    // add more aircraft as needed
  };

  const fixedBlockMinutes = 30;
  const baseFuelPrice = 1.07;

  let map;
  let routeLayer;
  let analyticsChart;

  function formatNumber(num) {
    return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
  }

  function formatFlightTime(hours) {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return `${h} hr ${m} min`;
  }

  // Simulated distance calculation (replace with real API call)
  function getDistance(origin, destination) {
    // Simple placeholder distances
    const distances = {
      'JFK-ORD': 740,
      'ORD-LAX': 1460,
      'JFK-LAX': 2475
    };
    const key = `${origin}-${destination}`;
    return distances[key] || 500; // default 500 NM if unknown
  }

  async function calculateFlight() {
    const routeInput = document.getElementById('route').value.trim().toUpperCase();
    const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();

    if (!aircraftInfo[aircraftCode]) {
      alert('Aircraft code not found in database.');
      return;
    }
    const aircraft = aircraftInfo[aircraftCode];

    const fuelPricePerKg = parseFloat(document.getElementById('fuelPrice').value) || baseFuelPrice;
    const acmiRate = parseFloat(document.getElementById('acmiRate').value) || aircraft.acmiRate;
    const navRate = parseFloat(document.getElementById('navRate').value);

    const airports = routeInput.split('-');
    if (airports.length < 2) { alert('Enter at least two airports.'); return; }

    let totalNM = 0, totalFlightTime = 0, totalBlockTime = 0, totalFuelBurn = 0;
    let totalFuelCost = 0, totalAcmiCost = 0, totalNavCharge = 0;
    let warningFlag = false;

    let flightData = [], costData = [], latlngs = [];

    for(let i=0; i<airports.length-1; i++) {
      const fromCode = airports[i];
      const toCode = airports[i+1];

      // placeholder for latlngs - static for demo
      latlngs.push([40 + i*5, -74 + i*5]);

      const nm = getDistance(fromCode, toCode);
      const flightTimeHrs = nm / aircraft.speed;
      const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;
      const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;
      const fuelCost = fuelBurnKg * fuelPricePerKg;
      const acmiCost = blockTimeHrs * acmiRate;
      const navCharge = nm * Math.pow(aircraft.maxTakeoffWeightKg/1000 / 50, 0.7) * navRate;

      totalNM += nm;
      totalFlightTime += flightTimeHrs;
      totalBlockTime += blockTimeHrs;
      totalFuelBurn += fuelBurnKg;
      totalFuelCost += fuelCost;
      totalAcmiCost += acmiCost;
      totalNavCharge += navCharge;

      if (nm > aircraft.maxRangeNM) warningFlag = true;

      flightData.push({from: fromCode, to: toCode, nm, flightTimeHrs, blockTimeHrs, fuelBurnKg});
      costData.push({from: fromCode, to: toCode, fuelCost, acmiCost, navCharge, total: fuelCost+acmiCost+navCharge});
    }

    // Build tables & text output
    let resultHTML = '';
    // Flight Data Table
    resultHTML += `<h2>Flight Data</h2><table><thead><tr>
      <th>From</th><th>To</th><th>Distance (NM)</th><th>Flight Time</th><th>Block Time</th><th>Fuel Burn (kg)</th>
    </tr></thead><tbody>`;
    flightData.forEach(d => {
      resultHTML += `<tr>
        <td>${d.from}</td><td>${d.to}</td><td>${formatNumber(d.nm)}</td>
        <td>${formatFlightTime(d.flightTimeHrs)}</td><td>${formatFlightTime(d.blockTimeHrs)}</td>
        <td>${formatNumber(d.fuelBurnKg)}</td>
      </tr>`;
    });
    resultHTML += `<tfoot><tr>
      <td colspan="2">Total</td>
      <td>${formatNumber(totalNM)}</td>
      <td>${formatFlightTime(totalFlightTime)}</td>
      <td>${formatFlightTime(totalBlockTime)}</td>
      <td>${formatNumber(totalFuelBurn)}</td>
    </tr></tfoot></table>`;

    // Cost Table
    resultHTML += `<h2>Cost Table</h2><table><thead><tr>
      <th>From</th><th>To</th><th>Fuel Cost (USD)</th><th>ACMI Cost (USD)</th><th>Navigation Charge (USD)</th><th>Total Cost (USD)</th>
    </tr></thead><tbody>`;
    costData.forEach(d => {
      resultHTML += `<tr>
        <td>${d.from}</td><td>${d.to}</td><td>${formatNumber(d.fuelCost)}</td>
        <td>${formatNumber(d.acmiCost)}</td><td>${formatNumber(d.navCharge)}</td><td>${formatNumber(d.total)}</td>
      </tr>`;
    });
    resultHTML += `<tfoot><tr>
      <td colspan="2">Total</td>
      <td>${formatNumber(totalFuelCost)}</td>
      <td>${formatNumber(totalAcmiCost)}</td>
      <td>${formatNumber(totalNavCharge)}</td>
      <td>${formatNumber(totalFuelCost+totalAcmiCost+totalNavCharge)}</td>
    </tr></tfoot></table>`;

    // Airlines and countries and Cost assumptions not included for brevity

    document.getElementById('result').innerHTML = resultHTML;

    // Map
    if (routeLayer) {
      routeLayer.remove();
    }
    if (!map) {
      map = L.map('map').setView(latlngs[0], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap'
      }).addTo(map);
    }
    routeLayer = L.polyline(latlngs, {color: 'blue'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
    latlngs.forEach((latlng, idx) => {
      L.marker(latlng).addTo(map).bindPopup(airports[idx]);
    });

    // Analytics chart
    renderAnalyticsChart(totalFuelCost, totalAcmiCost, totalNavCharge, totalNM, totalBlockTime, totalFuelBurn, aircraft.seats);

    document.getElementById('route').disabled = true;
    document.getElementById('aircraft').disabled = true;
    document.getElementById('fuelPrice').disabled = true;
    document.getElementById('acmiRate').disabled = true;
    document.getElementById('navRate').disabled = true;
    document.getElementById('calculateBtn').style.display = 'none';
    document.getElementById('queryAgainBtn').style.display = 'inline-block';
  }

  function renderAnalyticsChart(totalFuelCost, totalAcmiCost, totalNavCharge, totalNM, totalBlockTime, totalFuelBurn, seats) {
    const ctx = document.getElementById('analyticsChart').getContext('2d');

    if(analyticsChart) {
      analyticsChart.destroy();
    }

    analyticsChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Fuel', 'ACMI', 'Navigation'],
        datasets: [{
          data: [totalFuelCost, totalAcmiCost, totalNavCharge],
          backgroundColor: ['#4f46e5', '#3b82f6', '#f87171'],
          hoverOffset: 30
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Cost Breakdown (USD)' }
        }
      }
    });

    // Display textual key metrics under the chart
    const analyticsText = `
      <p><strong>Cost per NM:</strong> $${((totalFuelCost + totalAcmiCost + totalNavCharge) / totalNM).toFixed(2)}</p>
      <p><strong>Cost per Block Hour:</strong> $${((totalFuelCost + totalAcmiCost + totalNavCharge) / totalBlockTime).toFixed(2)}</p>
      <p><strong>Fuel per Seat-NM:</strong> ${(totalFuelBurn / (seats * totalNM)).toFixed(2)} kg</p>
    `;
    document.getElementById('analyticsText').innerHTML = analyticsText;
  }

  function resetApp() {
    document.getElementById('result').innerHTML = '';
    document.getElementById('analyticsChart').getContext('2d').clearRect(0,0,600,400);
    document.getElementById('analyticsText').innerHTML = '';
    document.getElementById('route').value = '';
    document.getElementById('aircraft').value = '';
    document.getElementById('fuelPrice').value = '1.07';
    document.getElementById('acmiRate').value = '';
    document.getElementById('navRate').value = '4';
    document.getElementById('route').disabled = false;
    document.getElementById('aircraft').disabled = false;
    document.getElementById('fuelPrice').disabled = false;
    document.getElementById('acmiRate').disabled = false;
    document.getElementById('navRate').disabled = false;
    document.getElementById('calculateBtn').style.display = 'inline-block';
    document.getElementById('queryAgainBtn').style.display = 'none';
    if(routeLayer) routeLayer.remove();
  }
</script>
</body>
</html>
