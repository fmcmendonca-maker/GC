<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flight Cost Calculator with Improved Navigation Charges</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin: 10px 0 5px; }
  input, select { padding: 8px; width: 100%; max-width: 400px; }
  button { padding: 10px 15px; margin-top: 10px; }
  table { margin-top: 10px; border-collapse: collapse; width: 100%; max-width: 1200px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; white-space: nowrap; }
  th { background-color: #f5f5f5; }
  .warning { color: red; font-weight: bold; }
  #map { height: 400px; max-width: 900px; margin-top: 20px; }
  #footer { margin-top: 30px; font-size: 0.9em; color: #666; text-align: center; }
  h2 { margin-top: 30px; }
  #queryAgainBtn { margin-top: 20px; display: none;}
  #fuelPriceContainer, #acmiRateContainer { display: none; }
  span.toggle-button { color: blue; cursor: pointer; text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<h1>Multi-Leg Flight Distance & Cost Calculator</h1>

<label for="route">Route (e.g. FRA-LIS-MAD):</label>
<input type="text" id="route" placeholder="Enter multi-leg route, e.g., FRA-LIS-MAD" />

<label for="aircraft">Aircraft Code (e.g. B738, A320):</label>
<input type="text" id="aircraft" maxlength="5" placeholder="e.g. B738" />

<div id="fuelPriceContainer">
  <label for="fuelPrice">Fuel Price (USD/kg):</label>
  <input type="number" id="fuelPrice" step="0.01" value="1.07" />
</div>
<div id="infoBasePrice">
  Using base fuel price <strong>$1.07 USD/kg</strong> from 
  <a href="https://www.iata.org/en/publications/economics/fuel-monitor/" target="_blank" rel="noopener">IATA Jet Fuel Price Monitor</a> (Oct 2025).
  <span id="toggleFuelPriceBtn" class="toggle-button">Change</span>
</div>

<div id="acmiRateContainer">
  <label for="acmiRate">ACMI Hourly Rate (USD):</label>
  <input type="number" id="acmiRate" step="10" value="4000" />
</div>
<div id="infoBaseAcmi">
  Using default ACMI hourly rates by aircraft type (editable).
  <span id="toggleAcmiRateBtn" class="toggle-button">Change</span>
</div>

<label for="navRate">Air Navigation Fee Rate (USD/NM) - used if custom override:</label>
<input type="number" id="navRate" step="0.1" value="4.0" />

<button id="calculateBtn">Calculate</button>
<button id="queryAgainBtn">Query Again</button>

<div id="flightData"></div>
<div id="costData"></div>
<div id="airportData"></div>

<div id="map"></div>

<div id="footer">© Aerohub   Version 4.03   Oct2025 NavCharges V3</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  let map = null;
  let routeLayer = null;
  const fixedBlockMinutes = 30;
  const baseFuelPrice = 1.07;
  let useBaseFuelPrice = true;
  let useDefaultAcmiRate = true;

  // Example aircraft data
  const aircraftInfo = {
    B738: { maxTakeoffWeightKg: 79015, speed: 450, fuelBurnKgPerHr: 2500, maxRangeNM: 2800, acmiRate: 4000 },
    A320: { maxTakeoffWeightKg: 73500, speed: 460, fuelBurnKgPerHr: 2400, maxRangeNM: 3200, acmiRate: 3800 },
  };

  // Navigation charges data by region and country
  const navChargesData = {
    regions: {
      EUR: { baseRate: 85, countries: ['FR', 'DE', 'GB', 'IT', 'ES', 'PT', 'CH', 'AT', 'BE', 'NL', 'DK', 'NO', 'SE', 'FI'] },
      NAM: { baseRate: 35, countries: ['US', 'CA'] },
      ASIA: { baseRate: 55, countries: ['CN', 'JP', 'KR', 'SG', 'TH', 'MY', 'ID', 'IN', 'PH', 'VN'] },
      MEA: { baseRate: 65, countries: ['AE', 'SA', 'QA', 'BH', 'OM', 'KW'] },
      AFR: { baseRate: 45, countries: ['ZA', 'EG', 'MA', 'NG', 'KE', 'ET'] },
      SAM: { baseRate: 40, countries: ['BR', 'AR', 'CL', 'CO', 'PE', 'VE'] },
      OCE: { baseRate: 50, countries: ['AU', 'NZ', 'FJ', 'PG'] }
    },
    countryRates: { 'CH': 95, 'GB': 80, 'SG': 65, 'JP': 70 }
  };

  // Toggle fuel price input visibility
  document.getElementById('toggleFuelPriceBtn').addEventListener('click', () => {
    const container = document.getElementById('fuelPriceContainer');
    const info = document.getElementById('infoBasePrice');
    if(container.style.display === 'none' || container.style.display === '') {
      container.style.display = 'block';
      info.style.display = 'none';
      useBaseFuelPrice = false;
    } else {
      container.style.display = 'none';
      info.style.display = 'block';
      useBaseFuelPrice = true;
    }
  });

  // Toggle ACMI rate input visibility
  document.getElementById('toggleAcmiRateBtn').addEventListener('click', () => {
    const container = document.getElementById('acmiRateContainer');
    const info = document.getElementById('infoBaseAcmi');
    if(container.style.display === 'none' || container.style.display === '') {
      container.style.display = 'block';
      info.style.display = 'none';
      useDefaultAcmiRate = false;
    } else {
      container.style.display = 'none';
      info.style.display = 'block';
      useDefaultAcmiRate = true;
    }
  });

  function isValidAircraftCode(code) {
    return /^[A-Z0-9]{3,5}$/.test(code);
  }

  function formatFlightTime(hours) {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return `${h}h ${m}m`;
  }

  function formatNumberEU(num) {
    return num.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // Navigation charge calculation: average regional/country rates, sqrt MTOW scaling, per 100 NM
  function calculateNavCharges(fromCountry, toCountry, nm, mtowTons) {
    let fromRegion = 'OTHER';
    let toRegion = 'OTHER';

    for (const [region, data] of Object.entries(navChargesData.regions)) {
      if(data.countries.includes(fromCountry)) fromRegion = region;
      if(data.countries.includes(toCountry)) toRegion = region;
    }

    const fromRate = navChargesData.countryRates[fromCountry] || navChargesData.regions[fromRegion]?.baseRate || 45;
    const toRate = navChargesData.countryRates[toCountry] || navChargesData.regions[toRegion]?.baseRate || 45;

    const averageRate = (fromRate + toRate) / 2;
    const weightFactor = Math.sqrt(mtowTons / 50);
    const distanceFactor = nm / 100;

    return distanceFactor * weightFactor * averageRate;
  }

  // Dummy distance fetch function - replace with real API call as needed
  async function fetchDistanceWithCoords(fromCode, toCode) {
    return {
      data: {
        attributes: {
          nautical_miles: 500,
          from_airport: { country: 'FR', name: 'Paris CDG', city: 'Paris', latitude: 49.0097, longitude: 2.5479 },
          to_airport: { country: 'GB', name: 'London Heathrow', city: 'London', latitude: 51.4700, longitude: -0.4543 }
        }
      }
    };
  }

  document.getElementById('calculateBtn').addEventListener('click', calculateFlight);

  async function calculateFlight() {
    const routeInput = document.getElementById('route').value.trim().toUpperCase();
    const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();

    if(!isValidAircraftCode(aircraftCode)) {
      alert('Please enter a valid aircraft code (3-5 uppercase letters/digits, e.g., B738)');
      return;
    }
    if(!aircraftInfo[aircraftCode]) {
      alert('Aircraft code not found in database.');
      return;
    }

    const airports = routeInput.split('-');
    if(airports.length < 2) {
      alert('Please enter at least two airports separated by hyphens.');
      return;
    }
    for(const code of airports) {
      if(code.length !== 3) {
        alert('Each airport must be a 3-letter IATA code.');
        return;
      }
    }

    let fuelPricePerKg = baseFuelPrice;
    if(!useBaseFuelPrice) {
      fuelPricePerKg = parseFloat(document.getElementById('fuelPrice').value);
      if(isNaN(fuelPricePerKg) || fuelPricePerKg <= 0){
        alert('Please enter a valid fuel price per kg.');
        return;
      }
    }

    let acmiRate = aircraftInfo[aircraftCode].acmiRate;
    if(!useDefaultAcmiRate) {
      acmiRate = parseFloat(document.getElementById('acmiRate').value);
      if(isNaN(acmiRate) || acmiRate <= 0){
        alert('Please enter a valid ACMI hourly rate.');
        return;
      }
    }

    const aircraft = aircraftInfo[aircraftCode];
    const mtowTons = aircraft.maxTakeoffWeightKg / 1000;

    let legsData = [];
    let warningFlag = false;
    let latlngs = [];

    if(map) map.remove();
    map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    for(let i=0; i < airports.length -1; i++) {
      const fromCode = airports[i];
      const toCode = airports[i+1];
      try {
        const data = await fetchDistanceWithCoords(fromCode, toCode);
        if(!data?.data?.attributes) throw new Error('Invalid API response structure');
        const attr = data.data.attributes;

        const nm = attr.nautical_miles;
        const flightTimeHrs = nm / aircraft.speed;
        const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;
        const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;
        const fuelCost = fuelBurnKg * fuelPricePerKg;
        const acmiCost = blockTimeHrs * acmiRate;
        const navCharge = calculateNavCharges(attr.from_airport.country, attr.to_airport.country, nm, mtowTons);

        if(nm > aircraft.maxRangeNM) warningFlag = true;

        legsData.push({
          from: fromCode, to: toCode, distanceNM: nm, flightTimeHrs, blockTimeHrs,
          fuelBurnKg, fuelCost, acmiCost, navCharge,
          fromCountry: attr.from_airport.country, toCountry: attr.to_airport.country,
          fromAirportName: attr.from_airport.name, toAirportName: attr.to_airport.name,
          fromAirportCity: attr.from_airport.city || '', toAirportCity: attr.to_airport.city || ''
        });

        latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
        if(i === airports.length -2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);

      } catch(e) {
        alert(`Error fetching data for leg ${fromCode} to ${toCode}: ${e.message}`);
        return;
      }
    }

    const totals = legsData.reduce((acc, leg) => {
      acc.distanceNM += leg.distanceNM;
      acc.flightTimeHrs += leg.flightTimeHrs;
      acc.blockTimeHrs += leg.blockTimeHrs;
      acc.fuelBurnKg += leg.fuelBurnKg;
      acc.fuelCostUSD += leg.fuelCost;
      acc.acmiCostUSD += leg.acmiCost;
      acc.navChargeUSD += leg.navCharge;
      return acc;
    }, {distanceNM: 0, flightTimeHrs: 0, blockTimeHrs: 0, fuelBurnKg: 0, fuelCostUSD:0, acmiCostUSD:0, navChargeUSD:0});

    const totalCost = totals.fuelCostUSD + totals.acmiCostUSD + totals.navChargeUSD;

    let flightTableHTML = '<h2>Flight Data</h2><table><thead><tr>' +
          '<th>From</th><th>To</th><th>Distance (NM)</th><th>Flight Time</th><th>Block Time</th><th>Fuel Burn (kg)</th></tr></thead><tbody>';
    legsData.forEach(leg => {
      flightTableHTML += `<tr>
        <td>${leg.from}</td><td>${leg.to}</td><td>${formatNumberEU(leg.distanceNM)}</td><td>${formatFlightTime(leg.flightTimeHrs)}</td><td>${formatFlightTime(leg.blockTimeHrs)}</td><td>${formatNumberEU(leg.fuelBurnKg)}</td>
      </tr>`;
    });
    flightTableHTML += '</tbody></table>';
    document.getElementById('flightData').innerHTML = flightTableHTML;

    let costTableHTML = '<h2>Cost Summary</h2><table><thead><tr>' +
          '<th>Leg</th><th>Fuel Cost (USD)</th><th>ACMI Cost (USD)</th><th>Navigation Charge (USD)</th>' +
          '</tr></thead><tbody>';
    legsData.forEach(leg => {
      costTableHTML += `<tr>
        <td>${leg.from} → ${leg.to}</td><td>${formatNumberEU(leg.fuelCost)}</td><td>${formatNumberEU(leg.acmiCost)}</td><td>${formatNumberEU(leg.navCharge)}</td>
      </tr>`;
    });
    costTableHTML += `<tr style="font-weight:bold;">
      <td>Totals</td><td>${formatNumberEU(totals.fuelCostUSD)}</td><td>${formatNumberEU(totals.acmiCostUSD)}</td><td>${formatNumberEU(totals.navChargeUSD)}</td>
    </tr></tbody></table>`;
    costTableHTML += `<p><strong>Total Cost (USD):</strong> ${formatNumberEU(totalCost)}</p>`;
    costTableHTML += `<p>
      Fuel Cost: ${(totals.fuelCostUSD/totalCost*100).toFixed(0)}%<br/>
      ACMI Cost: ${(totals.acmiCostUSD/totalCost*100).toFixed(0)}%<br/>
      Navigation Charge: ${(totals.navChargeUSD/totalCost*100).toFixed(0)}%
    </p>`;
    document.getElementById('costData').innerHTML = costTableHTML;

    let airportTableHTML = '<h2>Country & Airport Data</h2><table><thead><tr>' +
          '<th>Airport Code</th><th>Airport Name</th><th>City</th><th>Country</th></tr></thead><tbody>';
    legsData.forEach(leg => {
      airportTableHTML += `<tr><td>${leg.from}</td><td>${leg.fromAirportName}</td><td>${leg.fromAirportCity}</td><td>${leg.fromCountry}</td></tr>`;
      airportTableHTML += `<tr><td>${leg.to}</td><td>${leg.toAirportName}</td><td>${leg.toAirportCity}</td><td>${leg.toCountry}</td></tr>`;
    });
    airportTableHTML += '</tbody></table>';
    document.getElementById('airportData').innerHTML = airportTableHTML;

    if(routeLayer) routeLayer.clearLayers();
    routeLayer = L.polyline(latlngs, {color: 'blue'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
    latlngs.forEach((latlng, idx) => {
      L.marker(latlng).addTo(map).bindPopup(airports[idx]).openPopup();
    });

    if(warningFlag) alert("Warning: One or more legs exceed aircraft max range!");

    document.getElementById('route').disabled = true;
    document.getElementById('aircraft').disabled = true;
    document.getElementById('fuelPrice').disabled = true;
    document.getElementById('acmiRate').disabled = true;
    document.getElementById('navRate').disabled = true;
    document.getElementById('calculateBtn').style.display = 'none';
    document.getElementById('queryAgainBtn').style.display = 'inline-block';
  }

  document.getElementById('queryAgainBtn').addEventListener('click', () => location.reload());
</script>
</body>
</html>
