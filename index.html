<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flight Cost Calculator - Version 4</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin: 10px 0 5px; }
  input, select { padding: 8px; width: 100%; max-width: 400px; }
  button { padding: 10px 15px; margin-top: 10px; }
  table { margin-top: 10px; border-collapse: collapse; width: 100%; max-width: 1200px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; white-space: nowrap; }
  th { background-color: #f5f5f5; }
  .warning { color: red; font-weight: bold; }
  #map { height: 400px; max-width: 900px; margin-top: 20px; }
  h2 { margin-top: 30px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<h1>Multi-Leg Flight Cost Calculator - Version 4</h1>

<label for="route">Route (e.g. JFK-ORD-LAX-MEX):</label>
<input type="text" id="route" placeholder="Enter multi-leg route, e.g. JFK-ORD-LAX-MEX" />

<label for="aircraft">Aircraft Code (e.g. B738, A320):</label>
<input type="text" id="aircraft" maxlength="5" placeholder="e.g. B738" />

<label for="fuelPrice">Fuel Price (USD/kg):</label>
<input type="number" id="fuelPrice" step="0.01" value="1.07" />

<label for="acmiRate">ACMI Hourly Rate (USD):</label>
<input type="number" id="acmiRate" step="10" value="4000" />

<label for="navRate">Air Navigation Fee Rate (USD/NM):</label>
<input type="number" id="navRate" step="0.1" value="4.0" />

<button id="calculateBtn">Calculate</button>
<button id="queryAgainBtn" style="display:none;">Query Again</button>

<div id="flightData"></div>
<div id="costData"></div>
<div id="airportData"></div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  let map = null;
  let routeLayer = null;
  const fixedBlockMinutes = 30;

  // Example aircraft data
  const aircraftInfo = {
    B738: { maxTakeoffWeightKg: 79015, speed: 450, fuelBurnKgPerHr: 2500, maxRangeNM: 2800, acmiRate: 4000 },
    A320: { maxTakeoffWeightKg: 73500, speed: 460, fuelBurnKgPerHr: 2400, maxRangeNM: 3200, acmiRate: 3800 },
  };

  // Navigation charges configuration
  const navConfig = {
    regionMultiplier: {
      EUR: 1.00,
      NAM: 0.90,
      ASIA: 0.95,
      MEA: 0.98,
      AFR: 0.85,
      SAM: 0.88,
      OCE: 0.92,
      OTHER: 0.95
    },
    regionCountries: {
      EUR: ['FR','DE','GB','IT','ES','PT','CH','AT','BE','NL','DK','NO','SE','FI','IE'],
      NAM: ['US','CA'],
      ASIA: ['CN','JP','KR','SG','TH','MY','ID','IN','PH','VN','HK','TW'],
      MEA: ['AE','SA','QA','BH','OM','KW','IL'],
      AFR: ['ZA','EG','MA','NG','KE','ET'],
      SAM: ['BR','AR','CL','CO','PE','VE','UY'],
      OCE: ['AU','NZ','FJ','PG']
    },
    countryMultiplier: {
      CH: 1.20,
      GB: 1.15,
      SG: 1.10,
      JP: 1.08
    }
  };

  function isValidAircraftCode(code) {
    return /^[A-Z0-9]{3,5}$/.test(code);
  }

  function determineRegionForCountry(c) {
    if (!c) return 'OTHER';
    c = c.toUpperCase();
    for (const [region, list] of Object.entries(navConfig.regionCountries)) {
      if (list.includes(c)) return region;
    }
    return 'OTHER';
  }

  function calculateNavCharges(fromCountry, toCountry, nm, mtowTons, navRate) {
    const fromRegion = determineRegionForCountry(fromCountry);
    const toRegion = determineRegionForCountry(toCountry);

    const fromRegionMul = navConfig.regionMultiplier[fromRegion] || navConfig.regionMultiplier.OTHER;
    const toRegionMul = navConfig.regionMultiplier[toRegion] || navConfig.regionMultiplier.OTHER;

    const fromCountryMul = navConfig.countryMultiplier[fromCountry] || 1.0;
    const toCountryMul = navConfig.countryMultiplier[toCountry] || 1.0;

    const regionMul = (fromRegionMul + toRegionMul) / 2;
    const countryMul = (fromCountryMul + toCountryMul) / 2;
    const totalMul = regionMul * countryMul;

    const weightFactor = Math.sqrt(Math.max(mtowTons, 0.001) / 50);

    const charge = navRate * nm * weightFactor * totalMul;

    return charge;
  }

  async function fetchDistanceWithCoords(origin, destination) {
    const response = await fetch('https://airportgap.com/api/airports/distance', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer token=iHPosKuEeLi2rJHtUNxNJtKo'
      },
      body: JSON.stringify({ from: origin.toUpperCase(), to: destination.toUpperCase() })
    });
    if (!response.ok) throw new Error('API error: ' + response.statusText);
    return response.json();
  }

  function formatFlightTime(hours) {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return `${h}h ${m}m`;
  }

  document.getElementById('calculateBtn').addEventListener('click', calculateFlight);
  document.getElementById('queryAgainBtn').addEventListener('click', resetApp);

  async function calculateFlight() {
    const routeInput = document.getElementById('route').value.trim().toUpperCase();
    const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();

    let fuelPricePerKg = parseFloat(document.getElementById('fuelPrice').value);
    if(isNaN(fuelPricePerKg) || fuelPricePerKg <= 0){
      fuelPricePerKg = 1.07;
    }

    let acmiRate = parseFloat(document.getElementById('acmiRate').value);
    if(isNaN(acmiRate) || acmiRate <= 0){
      acmiRate = aircraftInfo[aircraftCode]?.acmiRate || 4000;
    }

    const navRate = parseFloat(document.getElementById('navRate').value);
    if(isNaN(navRate) || navRate <=0){
      alert('Please enter valid navigation fee rate');
      return;
    }

    if(!isValidAircraftCode(aircraftCode)) {
      alert('Invalid aircraft code');
      return;
    }
    if(!aircraftInfo[aircraftCode]) {
      alert('Aircraft data not found');
      return;
    }

    const airports = routeInput.split('-').map(a=>a.trim()).filter(Boolean);
    if(airports.length < 2){
      alert('Enter at least two airports');
      return;
    }
    for (const airport of airports){
      if(airport.length !== 3){
        alert('Each airport must be 3-letter IATA');
        return;
      }
    }

    const aircraft = aircraftInfo[aircraftCode];
    const mtowTons = aircraft.maxTakeoffWeightKg / 1000;

    let legsData = [];
    let warningFlag = false;
    let latlngs = [];

    if(map) map.remove();
    map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:18,
      attribution:'© OpenStreetMap'
    }).addTo(map);

    try {
      for(let i=0; i<airports.length-1; i++){
        const fromCode = airports[i], toCode = airports[i+1];
        const data = await fetchDistanceWithCoords(fromCode, toCode);
        const attr = data.data.attributes;

        const nm = attr.nautical_miles;
        const flightTimeHrs = nm / aircraft.speed;
        const blockTimeHrs = flightTimeHrs + fixedBlockMinutes/60;
        const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;
        const fuelCost = fuelBurnKg * fuelPricePerKg;
        const acmiCost = blockTimeHrs * acmiRate;
        const navCharge = calculateNavCharges(attr.from_airport.country, attr.to_airport.country, nm, mtowTons, navRate);

        if(nm > aircraft.maxRangeNM) warningFlag = true;

        legsData.push({
          from: fromCode, to: toCode,
          distanceNM: nm,
          flightTimeHrs,
          blockTimeHrs,
          fuelBurnKg,
          fuelCost,
          acmiCost,
          navCharge,
          fromCountry: attr.from_airport.country,
          toCountry: attr.to_airport.country,
          fromAirportName: attr.from_airport.name,
          toAirportName: attr.to_airport.name,
          fromAirportCity: attr.from_airport.city || '',
          toAirportCity: attr.to_airport.city || '',
          fromLatLng: [attr.from_airport.latitude, attr.from_airport.longitude],
          toLatLng: [attr.to_airport.latitude, attr.to_airport.longitude]
        });

        latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
        if(i === airports.length -2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);
      }
    } catch(e){
      alert('Error fetching or processing route data: '+e.message);
      return;
    }

    // Calculate totals
    const totals = legsData.reduce((acc, leg) => {
      acc.distanceNM += leg.distanceNM;
      acc.flightTimeHrs += leg.flightTimeHrs;
      acc.blockTimeHrs += leg.blockTimeHrs;
      acc.fuelBurnKg += leg.fuelBurnKg;
      acc.fuelCostUSD += leg.fuelCost;
      acc.acmiCostUSD += leg.acmiCost;
      acc.navChargeUSD += leg.navCharge;
      return acc;
    }, {distanceNM:0, flightTimeHrs:0, blockTimeHrs:0, fuelBurnKg:0, fuelCostUSD:0, acmiCostUSD:0, navChargeUSD:0});

    const totalCost = totals.fuelCostUSD + totals.acmiCostUSD + totals.navChargeUSD;

    // Flight Data Table
    let flightTableHTML = `<h2>Flight Data</h2><table>
      <thead><tr>
        <th>From</th><th>To</th><th>Distance (NM)</th><th>Flight Time</th><th>Block Time</th><th>Fuel Burn (kg)</th>
      </tr></thead><tbody>`;
    legsData.forEach(leg => {
      flightTableHTML += `<tr>
        <td>${leg.from}</td><td>${leg.to}</td><td>${leg.distanceNM.toFixed(2)}</td><td>${formatFlightTime(leg.flightTimeHrs)}</td><td>${formatFlightTime(leg.blockTimeHrs)}</td><td>${leg.fuelBurnKg.toFixed(0)}</td>
      </tr>`;
    });
    flightTableHTML += `</tbody></table>`;
    document.getElementById('flightData').innerHTML = flightTableHTML;

    // Cost Summary Table
    let costTableHTML = `<h2>Cost Summary</h2><table>
      <thead><tr>
        <th>Leg</th><th>Fuel Cost (USD)</th><th>ACMI Cost (USD)</th><th>Navigation Charge (USD)</th>
      </tr></thead><tbody>`;
    legsData.forEach(leg => {
      costTableHTML += `<tr>
        <td>${leg.from} → ${leg.to}</td><td>${leg.fuelCost.toFixed(2)}</td><td>${leg.acmiCost.toFixed(2)}</td><td>${leg.navCharge.toFixed(2)}</td>
      </tr>`;
    });
    costTableHTML += `<tr style="font-weight:bold;">
      <td>Totals</td><td>${totals.fuelCostUSD.toFixed(2)}</td><td>${totals.acmiCostUSD.toFixed(2)}</td><td>${totals.navChargeUSD.toFixed(2)}</td>
    </tr></tbody></table>`;
    costTableHTML += `<p><strong>Total Cost (USD):</strong> ${totalCost.toFixed(2)}</p>`;
    document.getElementById('costData').innerHTML = costTableHTML;

    // Airport Data Table
    const uniqueAirports = new Map();
    legsData.forEach(leg => {
      uniqueAirports.set(leg.from, {name: leg.fromAirportName, city: leg.fromAirportCity, country: leg.fromCountry});
      uniqueAirports.set(leg.to, {name: leg.toAirportName, city: leg.toAirportCity, country: leg.toCountry});
    });
    let airportTableHTML = `<h2>Airport Data</h2><table>
      <thead><tr><th>Code</th><th>Name</th><th>City</th><th>Country</th></tr></thead><tbody>`;
    uniqueAirports.forEach((info, code) => {
      airportTableHTML += `<tr>
        <td>${code}</td><td>${info.name}</td><td>${info.city}</td><td>${info.country}</td>
      </tr>`;
    });
    airportTableHTML += `</tbody></table>`;

    // Overflown countries (first 5 distinct)
    const countriesSet = new Set();
    legsData.forEach(leg => {
      if(leg.fromCountry) countriesSet.add(leg.fromCountry);
      if(leg.toCountry) countriesSet.add(leg.toCountry);
    });
    const overflown = Array.from(countriesSet).slice(0,5);
    let overflownHTML = `<h2>Overflown Countries (up to 5)</h2><ul>`;
    overflown.forEach(c => { overflownHTML += `<li>${c}</li>`; });
    overflownHTML += '</ul>';

    document.getElementById('airportData').innerHTML = airportTableHTML + overflownHTML;

    // Map visualization
    if(routeLayer) routeLayer.clearLayers();
    routeLayer = L.polyline(latlngs, {color:'blue'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
    latlngs.forEach((latlng, idx) => {
      L.marker(latlng).addTo(map).bindPopup(airports[idx]).openPopup();
    });

    if(warningFlag) alert("Warning: One or more legs exceed aircraft max range!");

    // Disable form controls
    ['route','aircraft','fuelPrice','acmiRate','navRate','calculateBtn'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.disabled = true;
    });
    document.getElementById('calculateBtn').style.display = 'none';
    document.getElementById('queryAgainBtn').style.display = 'inline-block';
  }

  function resetApp(){
    document.getElementById('result').innerHTML = '';
    ['route','aircraft','fuelPrice','acmiRate','navRate','calculateBtn'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.disabled = false;
    });
    document.getElementById('calculateBtn').style.display = 'inline-block';
    document.getElementById('queryAgainBtn').style.display = 'none';

    if(routeLayer) routeLayer.clearLayers();
  }
</script>
</body>
</html>
