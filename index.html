<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Cost Calculator v5.04</title>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet" />

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map { height: 420px; }
    body.dark { background-color: #0b0b0e; color: #e7e7ea; }
    .card { border-radius: 0.75rem; box-shadow: 0 2px 14px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.06); padding: 1rem; }
    .dark .card { border-color:#2a2b35; background-color:#101116; }
    .tbl { width:100%; font-size:0.9rem; border:1px solid rgba(0,0,0,0.08); border-radius:0.5rem; overflow:hidden; }
    .dark .tbl { border-color:#2a2b35; }
    .tbl th { background:#f6f7f9; text-align:left; font-weight:600; padding:0.5rem 0.75rem; white-space:nowrap; }
    .dark .tbl th { background:#1a1b22; }
    .tbl td { padding:0.5rem 0.75rem; border-top:1px solid rgba(0,0,0,0.08); }
    .dark .tbl td { border-top-color:#2a2b35; }
    .tbl tfoot td { font-weight:700; background:#fafafa; }
    .dark .tbl tfoot td { background:#151621; }
    .section-title { font-size:1.125rem; font-weight:700; margin-bottom:0.5rem; }
    .badge { display:inline-block; font-size:0.7rem; padding:0.2rem 0.5rem; border-radius:0.5rem; background:#eef2ff; color:#374151; }
    .dark .badge { background:#1a1b22; color:#c9c9ce; }
    .hint { font-size:0.75rem; color:#6b7280; }
    .dark .hint { color:#a1a1aa; }
  </style>
</head>

<body class="p-4">
  <div class="container mx-auto max-w-7xl space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-3xl font-bold">Multi-Leg Charter Price Calculator <span class="badge">v5.04</span></h1>
      <div class="flex items-center gap-3">
        <select id="currency" class="border rounded px-3 py-2">
          <option value="USD" selected>USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="CAD">CAD</option>
          <option value="AUD">AUD</option>
          <option value="JPY">JPY</option>
          <option value="MXN">MXN</option>
        </select>
        <button onclick="toggleTheme()" class="bg-gray-900 text-white px-3 py-2 rounded">Toggle Theme</button>
      </div>
    </header>

    <!-- Inputs -->
    <section class="card space-y-4">
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label for="route" class="font-semibold">Route (e.g. JFK-ORD-LAX-MEX)</label>
          <input type="text" id="route" class="w-full border p-2 rounded mt-1" placeholder="Enter route e.g. JFK-ORD-LAX-MEX">
          <p class="hint mt-1">Use IATA 3-letter codes. Hyphens auto-insert as you type.</p>
        </div>
        <div>
          <label for="aircraft" class="font-semibold">Aircraft Code (e.g. B738, A320)</label>
          <input type="text" id="aircraft" class="w-full border p-2 rounded mt-1" maxlength="5" placeholder="e.g. B738">
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <label for="fuelPrice" class="font-semibold">Fuel Price (USD/kg)</label>
          <input type="number" id="fuelPrice" class="w-full border p-2 rounded mt-1" step="0.01" value="1.07">
        </div>
        <div>
          <label for="acmiRate" class="font-semibold">ACMI Hourly (USD)</label>
          <input type="number" id="acmiRate" class="w-full border p-2 rounded mt-1" step="10">
        </div>
        <div>
          <label for="navRate" class="font-semibold">Nav Fee (USD/NM)</label>
          <input type="number" id="navRate" class="w-full border p-2 rounded mt-1" step="0.1" value="4">
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <label for="landingRate" class="font-semibold">Landing Fee (USD/ton)</label>
          <input type="number" id="landingRate" class="w-full border p-2 rounded mt-1" step="1" value="15">
        </div>
        <div>
          <label for="handlingRate" class="font-semibold">Handling Fee (USD/ton)</label>
          <input type="number" id="handlingRate" class="w-full border p-2 rounded mt-1" step="1" value="10">
        </div>
        <div>
          <label for="groundFee" class="font-semibold">Ground Service (USD/stop)</label>
          <input type="number" id="groundFee" class="w-full border p-2 rounded mt-1" step="10" value="500">
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="calculateBtn" onclick="calculateFlight()" class="bg-blue-600 text-white px-4 py-2 rounded">Calculate</button>
        <button id="queryAgainBtn" onclick="resetApp()" class="hidden bg-gray-600 text-white px-4 py-2 rounded">New Query</button>
        <span id="ratesInfo" class="hint self-center"></span>
      </div>
    </section>

    <!-- Results: Four Tables -->
    <section class="grid lg:grid-cols-2 gap-6">
      <!-- Table 1 — Flight Summary -->
      <div class="card">
        <h2 class="section-title">Table 1 — Flight Summary</h2>
        <table class="tbl">
          <tbody id="summaryBody">
            <tr><td>Aircraft Code</td><td>—</td></tr>
            <tr><td>Aircraft Model</td><td>—</td></tr>
            <tr><td>MTOW</td><td>—</td></tr>
            <tr><td>ACMI Rate (per Block Hour)</td><td>—</td></tr>
            <tr><td>Total Distance</td><td>—</td></tr>
            <tr><td>Total Block Time</td><td>—</td></tr>
            <tr><td>Total Fuel Burn</td><td>—</td></tr>
            <tr><td>Total Cost</td><td>—</td></tr>
            <tr><td>Warnings</td><td>—</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Table 2 — Cost Summary -->
      <div class="card">
        <h2 class="section-title">Table 2 — Cost Summary</h2>
        <table class="tbl">
          <thead>
            <tr><th>Cost Component</th><th>Total</th></tr>
          </thead>
          <tbody id="costSummaryBody">
            <tr><td>Fuel Cost</td><td>—</td></tr>
            <tr><td>ACMI Cost</td><td>—</td></tr>
            <tr><td>Navigation Charges</td><td>—</td></tr>
            <tr><td>Landing Fees</td><td>—</td></tr>
            <tr><td>Handling Fees</td><td>—</td></tr>
            <tr><td>Ground Service Fees</td><td>—</td></tr>
          </tbody>
          <tfoot>
            <tr><td>Grand Total</td><td id="grandTotalCell">—</td></tr>
          </tfoot>
        </table>
      </div>

      <!-- Table 3 — Analytics Summary -->
      <div class="card">
        <h2 class="section-title">Table 3 — Analytics Summary</h2>
        <table class="tbl">
          <tbody id="analyticsBody">
            <tr><td>Cost per NM</td><td>—</td></tr>
            <tr><td>Cost per Block Hour</td><td>—</td></tr>
            <tr><td>Fuel per NM</td><td>—</td></tr>
            <tr><td>Fuel per Block Hour</td><td>—</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Table 4 — Airports & Countries -->
      <div class="card">
        <h2 class="section-title">Table 4 — Airports & Countries</h2>
        <div class="overflow-x-auto">
          <table class="tbl">
            <thead>
              <tr><th>Airport Code</th><th>Airport Name</th><th>Country</th><th>City</th></tr>
            </thead>
            <tbody id="airportTBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section class="card">
      <h2 class="section-title">Route Map</h2>
      <div id="map" class="rounded"></div>
    </section>

    <footer class="text-center hint">
      © Aerohub Version 5.04 — 27 Oct 2025
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ===== State =====
    let aircraftInfo = {};
    let map, routeLayer;
    let exchangeRates = { USD: 1 };
    let ratesFetchedAt = null;

    // Cache the last computed (USD) result so currency changes can re-render without recomputing distances
    let lastResult = null;

    const fixedBlockMinutes = 30;
    const baseFuelPrice = 1.07;

    // ===== Load aircraft data =====
    fetch('aircraftData.json')
      .then(r => r.json())
      .then(d => aircraftInfo = d.aircraft)
      .catch(err => alert("Error loading aircraft data: " + err.message));

    // ===== Currency rates (cache in localStorage 24h) =====
    async function fetchRates() {
      try {
        const cached = JSON.parse(localStorage.getItem('fx_cache') || 'null');
        const now = Date.now();
        if (cached && now - cached.time < 24 * 3600 * 1000) {
          exchangeRates = cached.rates;
          ratesFetchedAt = new Date(cached.time);
          renderRatesInfo();
          return;
        }
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await res.json();
        if (data && data.result === 'success') {
          exchangeRates = data.rates;
          ratesFetchedAt = new Date();
          localStorage.setItem('fx_cache', JSON.stringify({ time: Date.now(), rates: exchangeRates }));
          renderRatesInfo();
        } else {
          throw new Error('FX API not successful');
        }
      } catch (e) {
        console.warn('Exchange rate API unavailable. Using USD only.', e);
        exchangeRates = { USD: 1 };
        ratesFetchedAt = null;
        renderRatesInfo(true);
      }
    }
    fetchRates();

    function renderRatesInfo(failed=false) {
      const el = document.getElementById('ratesInfo');
      if (failed) el.textContent = 'FX: offline (USD only)';
      else el.textContent = ratesFetchedAt ? ('FX cached: ' + ratesFetchedAt.toLocaleString()) : 'FX ready';
    }

    // ===== Helpers =====
    const routeInput = document.getElementById('route');
    routeInput.addEventListener('input', () => {
      let v = routeInput.value.replace(/-/g, '').toUpperCase().replace(/[^A-Z]/g, '');
      let out = '';
      for (let i = 0; i < v.length; i += 3) out += v.substring(i, i + 3) + '-';
      if (v.length % 3 === 0 && out.endsWith('-')) out = out.slice(0, -1);
      routeInput.value = out;
    });

    function toggleTheme() { document.body.classList.toggle('dark'); }

    function saveInputs() {
      localStorage.setItem('lastRoute', document.getElementById('route').value);
      localStorage.setItem('lastAircraft', document.getElementById('aircraft').value);
      localStorage.setItem('lastInputs', JSON.stringify({
        fuelPrice: document.getElementById('fuelPrice').value,
        acmiRate: document.getElementById('acmiRate').value,
        navRate: document.getElementById('navRate').value,
        landingRate: document.getElementById('landingRate').value,
        handlingRate: document.getElementById('handlingRate').value,
        groundFee: document.getElementById('groundFee').value,
        currency: document.getElementById('currency').value
      }));
    }
    (function loadSaved(){
      document.getElementById('route').value = localStorage.getItem('lastRoute') || '';
      document.getElementById('aircraft').value = localStorage.getItem('lastAircraft') || '';
      const li = JSON.parse(localStorage.getItem('lastInputs') || 'null');
      if (li) {
        document.getElementById('fuelPrice').value = li.fuelPrice ?? 1.07;
        document.getElementById('acmiRate').value  = li.acmiRate ?? '';
        document.getElementById('navRate').value   = li.navRate ?? 4;
        document.getElementById('landingRate').value = li.landingRate ?? 15;
        document.getElementById('handlingRate').value = li.handlingRate ?? 10;
        document.getElementById('groundFee').value  = li.groundFee ?? 500;
        document.getElementById('currency').value   = li.currency ?? 'USD';
      }
    })();

    const formatNumber = (n, max=0) => Number(n).toLocaleString('en-US',{maximumFractionDigits:max});
    const formatFlightTime = (h) => {
      const H = Math.floor(h); const M = Math.round((h - H) * 60);
      return `${H} hr ${M} min`;
    };
    function getRate() { const cur = document.getElementById('currency').value || 'USD'; return [cur, exchangeRates?.[cur] ?? 1]; }
    function money(v) {
      const [cur, rate] = getRate();
      const conv = v * rate;
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: cur, maximumFractionDigits: 0 }).format(conv);
    }

    async function fetchDistanceWithCoords(origin, destination) {
      const res = await fetch('https://airportgap.com/api/airports/distance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer iHPosKuEeLi2rJHtUNxNJtKo' },
        body: JSON.stringify({ from: origin.toUpperCase(), to: destination.toUpperCase() })
      });
      if (!res.ok) throw new Error('API error: ' + res.statusText);
      return res.json();
    }

    // ===== Render everything from lastResult (currency-safe) =====
    function renderAll() {
      if (!lastResult) return;
      const { code, ac, acmiRate, totals, airportsInfo, warning } = lastResult;

      // Table 1 — Flight Summary
      document.getElementById('summaryBody').innerHTML = `
        <tr><td>Aircraft Code</td><td>${code}</td></tr>
        <tr><td>Aircraft Model</td><td>${ac.model}</td></tr>
        <tr><td>MTOW</td><td>${formatNumber(ac.maxTakeoffWeightKg)} kg</td></tr>
        <tr><td>ACMI Rate (per Block Hour)</td><td>${money(acmiRate)}</td></tr>
        <tr><td>Total Distance</td><td>${formatNumber(totals.totalNM)} NM</td></tr>
        <tr><td>Total Block Time</td><td>${formatFlightTime(totals.totalBlock)}</td></tr>
        <tr><td>Total Fuel Burn</td><td>${formatNumber(totals.totalFuel)} kg</td></tr>
        <tr><td>Total Cost</td><td>${money(totals.grandTotal)}</td></tr>
        <tr><td>Warnings</td><td>${warning ? '<span class="text-red-600 font-semibold">One or more legs exceed max range!</span>' : 'None'}</td></tr>
      `;

      // Table 2 — Cost Summary
      document.getElementById('costSummaryBody').innerHTML = `
        <tr><td>Fuel Cost</td><td>${money(totals.totalFuelCost)}</td></tr>
        <tr><td>ACMI Cost</td><td>${money(totals.totalAcmi)}</td></tr>
        <tr><td>Navigation Charges</td><td>${money(totals.totalNav)}</td></tr>
        <tr><td>Landing Fees</td><td>${money(totals.totalLanding)}</td></tr>
        <tr><td>Handling Fees</td><td>${money(totals.totalHandling)}</td></tr>
        <tr><td>Ground Service Fees</td><td>${money(totals.totalGround)}</td></tr>
      `;
      document.getElementById('grandTotalCell').textContent = money(totals.grandTotal);

      // Table 3 — Analytics Summary
      const costPerNM = totals.grandTotal / Math.max(1, totals.totalNM);
      const costPerBlockHr = totals.grandTotal / Math.max(0.01, totals.totalBlock);
      const fuelPerNM = totals.totalFuel / Math.max(1, totals.totalNM);
      const fuelPerBlockHr = totals.totalFuel / Math.max(0.01, totals.totalBlock);
      document.getElementById('analyticsBody').innerHTML = `
        <tr><td>Cost per NM</td><td>${money(costPerNM)}</td></tr>
        <tr><td>Cost per Block Hour</td><td>${money(costPerBlockHr)}</td></tr>
        <tr><td>Fuel per NM</td><td>${fuelPerNM.toFixed(1)} kg</td></tr>
        <tr><td>Fuel per Block Hour</td><td>${fuelPerBlockHr.toFixed(0)} kg</td></tr>
      `;

      // Table 4 — Airports & Countries
      const aBody = document.getElementById('airportTBody');
      aBody.innerHTML = '';
      airportsInfo.forEach(a => {
        aBody.innerHTML += `<tr>
          <td>${a.code || '-'}</td>
          <td>${a.name || '-'}</td>
          <td>${a.country || '-'}</td>
          <td>${a.city || '-'}</td>
        </tr>`;
      });
    }

    // ===== Calculate (fetch distances, compute USD, store, then render) =====
    async function calculateFlight() {
      // Validate route
      let routeVal = document.getElementById('route').value.trim();
      if (routeVal.endsWith('-')) routeVal = routeVal.slice(0, -1);
      if (!/^[A-Z]{3}(-[A-Z]{3})+$/.test(routeVal)) {
        alert('Invalid route format. Use IATA codes like JFK-LAX-MEX.');
        return;
      }
      const airports = routeVal.split('-');

      // Aircraft
      const code = document.getElementById('aircraft').value.trim().toUpperCase();
      if (!aircraftInfo[code]) { alert('Aircraft code not found in database.'); return; }
      const ac = aircraftInfo[code];

      // Inputs
      const fuelPrice   = parseFloat(document.getElementById('fuelPrice').value) || baseFuelPrice;
      const acmiRate    = parseFloat(document.getElementById('acmiRate').value) || ac.acmiRate;
      const navRate     = parseFloat(document.getElementById('navRate').value);
      const landingRate = parseFloat(document.getElementById('landingRate').value);
      const handlingRate= parseFloat(document.getElementById('handlingRate').value);
      const groundFee   = parseFloat(document.getElementById('groundFee').value);

      // Totals (USD base)
      let totalNM=0, totalFlight=0, totalBlock=0, totalFuel=0;
      let totalFuelCost=0, totalAcmi=0, totalNav=0;
      let totalLanding=0, totalHandling=0, totalGround=0;
      let warning=false;

      // Map init
      if (!map) {
        map = L.map('map').setView([20,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:18, attribution:'© OpenStreetMap' }).addTo(map);
      }
      if (routeLayer) routeLayer.remove();

      const latlngs = [];
      const airportsMap = new Map(); // code -> {code,name,country,city,lat,lng}

      // Process legs
      for (let i=0; i<airports.length-1; i++) {
        const from = airports[i], to = airports[i+1];
        try {
          const data = await fetchDistanceWithCoords(from, to);
          const attr = data.data.attributes;
          const nm = attr.nautical_miles;

          const fHrs = nm / ac.speed;
          const bHrs = fHrs + fixedBlockMinutes/60;
          const fuelBurn = fHrs * ac.fuelBurnKgPerHr;

          const fuelCost = fuelBurn * fuelPrice;
          const acmiCost = bHrs * acmiRate;
          const navCharge = nm * Math.pow(ac.maxTakeoffWeightKg/1000 / 50, 0.7) * navRate;

          const landingFee = (ac.maxTakeoffWeightKg/1000) * landingRate;
          const handlingFee = (ac.maxTakeoffWeightKg/1000) * handlingRate;
          const groundServiceFee = groundFee;

          totalNM += nm; totalFlight += fHrs; totalBlock += bHrs; totalFuel += fuelBurn;
          totalFuelCost += fuelCost; totalAcmi += acmiCost; totalNav += navCharge;
          totalLanding += landingFee; totalHandling += handlingFee; totalGround += groundServiceFee;

          if (nm > ac.maxRangeNM) warning = true;

          // Map points
          latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
          if (i === airports.length-2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);

          // Collect airports info (unique)
          const fa = attr.from_airport, ta = attr.to_airport;
          if (fa?.iata && !airportsMap.has(fa.iata)) {
            airportsMap.set(fa.iata, {
              code: fa.iata, name: fa.name, country: fa.country,
              city: fa.municipality || fa.city || '', lat: fa.latitude, lng: fa.longitude
            });
          }
          if (ta?.iata && !airportsMap.has(ta.iata)) {
            airportsMap.set(ta.iata, {
              code: ta.iata, name: ta.name, country: ta.country,
              city: ta.municipality || ta.city || '', lat: ta.latitude, lng: ta.longitude
            });
          }
        } catch (e) {
          alert(`Error fetching ${from}-${to}: ${e.message}`);
          return;
        }
      }

      const grandTotal = totalFuelCost+totalAcmi+totalNav+totalLanding+totalHandling+totalGround;

      // Store last result in USD
      lastResult = {
        code, ac, acmiRate,
        totals: { totalNM, totalFlight, totalBlock, totalFuel, totalFuelCost, totalAcmi, totalNav, totalLanding, totalHandling, totalGround, grandTotal },
        airportsInfo: Array.from(airportsMap.values()),
        warning
      };

      // Render everything in selected currency
      renderAll();

      // Draw map (only once per calc)
      routeLayer = L.polyline(latlngs, { color: 'blue' }).addTo(map);
      map.fitBounds(routeLayer.getBounds());
      latlngs.forEach((p, i) => L.marker(p).addTo(map).bindPopup(airports[i]));

      // UI state & persist inputs
      document.getElementById('calculateBtn').classList.add('hidden');
      document.getElementById('queryAgainBtn').classList.remove('hidden');
      saveInputs();
    }

    function resetApp() {
      lastResult = null;
      document.getElementById('summaryBody').innerHTML = `
        <tr><td>Aircraft Code</td><td>—</td></tr>
        <tr><td>Aircraft Model</td><td>—</td></tr>
        <tr><td>MTOW</td><td>—</td></tr>
        <tr><td>ACMI Rate (per Block Hour)</td><td>—</td></tr>
        <tr><td>Total Distance</td><td>—</td></tr>
        <tr><td>Total Block Time</td><td>—</td></tr>
        <tr><td>Total Fuel Burn</td><td>—</td></tr>
        <tr><td>Total Cost</td><td>—</td></tr>
        <tr><td>Warnings</td><td>—</td></tr>`;
      document.getElementById('costSummaryBody').innerHTML = `
        <tr><td>Fuel Cost</td><td>—</td></tr>
        <tr><td>ACMI Cost</td><td>—</td></tr>
        <tr><td>Navigation Charges</td><td>—</td></tr>
        <tr><td>Landing Fees</td><td>—</td></tr>
        <tr><td>Handling Fees</td><td>—</td></tr>
        <tr><td>Ground Service Fees</td><td>—</td></tr>`;
      document.getElementById('grandTotalCell').textContent = '—';
      document.getElementById('analyticsBody').innerHTML = `
        <tr><td>Cost per NM</td><td>—</td></tr>
        <tr><td>Cost per Block Hour</td><td>—</td></tr>
        <tr><td>Fuel per NM</td><td>—</td></tr>
        <tr><td>Fuel per Block Hour</td><td>—</td></tr>`;
      document.getElementById('airportTBody').innerHTML = '';
      if (routeLayer) routeLayer.remove();
      document.getElementById('calculateBtn').classList.remove('hidden');
      document.getElementById('queryAgainBtn').classList.add('hidden');
    }

    // Re-render on currency change without recomputing distances
    document.getElementById('currency').addEventListener('change', () => {
      if (lastResult) renderAll();
      saveInputs();
    });
  </script>
</body>
</html>
