<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Cost Calculator v5.02</title>

  <!-- Tailwind CSS for layout -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    #map { height: 400px; }
    body.dark {
      background-color: #111;
      color: #eee;
    }
    .dark table, .dark th, .dark td {
      border-color: #444;
    }
  </style>
</head>

<body class="p-4">
  <div class="container mx-auto max-w-6xl">
    <h1 class="text-3xl font-bold mb-4">Multi-Leg Charter Price Calculator v5.02</h1>

    <!-- Input Section -->
    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="space-y-4">
        <div>
          <label for="route" class="font-semibold">Route (e.g. JFK-ORD-LAX-MEX):</label>
          <input type="text" id="route" class="w-full border p-2 rounded" placeholder="Enter route e.g. JFK-ORD-LAX-MEX">
        </div>

        <div>
          <label for="aircraft" class="font-semibold">Aircraft Code (e.g. B738, A320):</label>
          <input type="text" id="aircraft" class="w-full border p-2 rounded" maxlength="5" placeholder="e.g. B738">
        </div>

        <div>
          <label for="fuelPrice" class="font-semibold">Fuel Price (USD/kg):</label>
          <input type="number" id="fuelPrice" class="w-full border p-2 rounded" step="0.01" value="1.07">
        </div>

        <div>
          <label for="acmiRate" class="font-semibold">ACMI Hourly Rate (USD):</label>
          <input type="number" id="acmiRate" class="w-full border p-2 rounded" step="10">
        </div>

        <div>
          <label for="navRate" class="font-semibold">Air Navigation Fee Rate (USD/NM):</label>
          <input type="number" id="navRate" class="w-full border p-2 rounded" step="0.1" value="4">
        </div>

        <div class="flex space-x-4">
          <button id="calculateBtn" onclick="calculateFlight()" class="bg-blue-600 text-white px-4 py-2 rounded">Calculate</button>
          <button id="queryAgainBtn" onclick="resetApp()" class="hidden bg-gray-600 text-white px-4 py-2 rounded">New Query</button>
          <button onclick="toggleTheme()" class="bg-gray-800 text-white px-4 py-2 rounded">Toggle Theme</button>
        </div>
      </div>

      <!-- Results -->
      <div id="result" class="space-y-4"></div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="mt-6"></div>
    <canvas id="costChart" class="mt-6"></canvas>

    <!-- Map -->
    <div id="map" class="mt-8 rounded shadow"></div>

    <div class="mt-6 text-center text-gray-500 text-sm">
      © Aerohub Version 5.02 — 27 Oct 2025
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let aircraftInfo = {};
    let map, routeLayer;

    // Load aircraft data
    fetch('aircraftData.json')
      .then(res => res.json())
      .then(data => aircraftInfo = data.aircraft)
      .catch(err => alert("Error loading aircraft data: " + err.message));

    const fixedBlockMinutes = 30;
    const baseFuelPrice = 1.07;

    // Auto-hyphen for route
    const routeInput = document.getElementById('route');
    routeInput.addEventListener('input', () => {
      let val = routeInput.value.replace(/-/g, '');
      let newVal = '';
      for (let i = 0; i < val.length; i += 3) newVal += val.substring(i, i + 3) + '-';
      if (val.length % 3 === 0) newVal = newVal.slice(0, -1);
      routeInput.value = newVal.toUpperCase();
    });

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    // Save/Load last route
    function saveRoute() {
      localStorage.setItem('lastRoute', document.getElementById('route').value);
      localStorage.setItem('lastAircraft', document.getElementById('aircraft').value);
    }
    function loadSaved() {
      document.getElementById('route').value = localStorage.getItem('lastRoute') || '';
      document.getElementById('aircraft').value = localStorage.getItem('lastAircraft') || '';
    }
    window.onload = loadSaved;

    // Formatters
    const formatNumber = num => num.toLocaleString('en-US', { maximumFractionDigits: 0 });
    const formatFlightTime = h => `${Math.floor(h)} hr ${Math.round((h % 1) * 60)} min`;

    // Fetch distance
    async function fetchDistanceWithCoords(origin, destination) {
      const res = await fetch('https://airportgap.com/api/airports/distance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer iHPosKuEeLi2rJHtUNxNJtKo' },
        body: JSON.stringify({ from: origin, to: destination })
      });
      if (!res.ok) throw new Error('API error: ' + res.statusText);
      return res.json();
    }

    async function calculateFlight() {
      let routeVal = routeInput.value.trim();
      if (routeVal.endsWith('-')) routeVal = routeVal.slice(0, -1);
      const airports = routeVal.split('-');
      if (airports.length < 2) return alert('Enter at least two airports.');

      const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();
      const aircraft = aircraftInfo[aircraftCode];
      if (!aircraft) return alert('Aircraft code not found in database.');

      const fuelPrice = parseFloat(document.getElementById('fuelPrice').value) || baseFuelPrice;
      const acmiRate = parseFloat(document.getElementById('acmiRate').value) || aircraft.acmiRate;
      const navRate = parseFloat(document.getElementById('navRate').value);

      let totalNM = 0, totalFlight = 0, totalBlock = 0, totalFuel = 0;
      let totalFuelCost = 0, totalAcmi = 0, totalNav = 0, warning = false;

      if (!map) {
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18, attribution: '© OpenStreetMap'
        }).addTo(map);
      }
      if (routeLayer) routeLayer.remove();

      const latlngs = [], flightData = [], costData = [];

      for (let i = 0; i < airports.length - 1; i++) {
        const from = airports[i], to = airports[i + 1];
        try {
          const data = await fetchDistanceWithCoords(from, to);
          const attr = data.data.attributes;
          const nm = attr.nautical_miles;
          const fHrs = nm / aircraft.speed;
          const bHrs = fHrs + fixedBlockMinutes / 60;
          const fuelBurn = fHrs * aircraft.fuelBurnKgPerHr;
          const fuelCost = fuelBurn * fuelPrice;
          const acmiCost = bHrs * acmiRate;
          const navCharge = nm * Math.pow(aircraft.maxTakeoffWeightKg / 1000 / 50, 0.7) * navRate;

          totalNM += nm; totalFlight += fHrs; totalBlock += bHrs;
          totalFuel += fuelBurn; totalFuelCost += fuelCost;
          totalAcmi += acmiCost; totalNav += navCharge;
          if (nm > aircraft.maxRangeNM) warning = true;

          latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
          if (i === airports.length - 2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);
          flightData.push({ from, to, nm, fHrs, bHrs, fuelBurn });
          costData.push({ from, to, fuelCost, acmiCost, navCharge });
        } catch (e) {
          alert(`Error fetching ${from}-${to}: ${e.message}`);
          return;
        }
      }

      // Build tables
      let html = `<h2 class='text-xl font-semibold'>Flight Data</h2>
      <table class='table-auto border w-full text-sm'>
        <thead><tr><th>From</th><th>To</th><th>NM</th><th>Flight Time</th><th>Block Time</th><th>Fuel Burn (kg)</th></tr></thead><tbody>`;
      flightData.forEach(d => {
        html += `<tr><td>${d.from}</td><td>${d.to}</td><td>${formatNumber(d.nm)}</td>
          <td>${formatFlightTime(d.fHrs)}</td><td>${formatFlightTime(d.bHrs)}</td>
          <td>${formatNumber(d.fuelBurn)}</td></tr>`;
      });
      html += `</tbody></table>`;

      html += `<h2 class='text-xl font-semibold mt-6'>Cost Table</h2>
      <table class='table-auto border w-full text-sm'>
        <thead><tr><th>From</th><th>To</th><th>Fuel (USD)</th><th>ACMI (USD)</th><th>Nav (USD)</th><th>Total</th></tr></thead><tbody>`;
      costData.forEach(d => {
        const total = d.fuelCost + d.acmiCost + d.navCharge;
        html += `<tr><td>${d.from}</td><td>${d.to}</td><td>${formatNumber(d.fuelCost)}</td>
          <td>${formatNumber(d.acmiCost)}</td><td>${formatNumber(d.navCharge)}</td><td>${formatNumber(total)}</td></tr>`;
      });
      html += `<tfoot><tr><td colspan='2'>Total</td><td>${formatNumber(totalFuelCost)}</td>
        <td>${formatNumber(totalAcmi)}</td><td>${formatNumber(totalNav)}</td>
        <td>${formatNumber(totalFuelCost + totalAcmi + totalNav)}</td></tr></tfoot></table>`;

      document.getElementById('result').innerHTML = html;

      // === Analytics Summary ===
      const totalCost = totalFuelCost + totalAcmi + totalNav;
      const costPerNM = totalCost / totalNM;
      const costPerBlockHr = totalCost / totalBlock;
      const fuelPerNM = totalFuel / totalNM;
      const fuelPerBlockHr = totalFuel / totalBlock;

      document.getElementById('analytics').innerHTML = `
        <h2 class='text-xl font-semibold mb-2'>Analytics Summary</h2>
        <table class='table-auto border w-full text-sm'>
          <tr><td>Cost per NM</td><td>$${costPerNM.toFixed(2)}</td></tr>
          <tr><td>Cost per Block Hour</td><td>$${costPerBlockHr.toFixed(0)}</td></tr>
          <tr><td>Fuel per NM</td><td>${fuelPerNM.toFixed(1)} kg</td></tr>
          <tr><td>Fuel per Block Hour</td><td>${fuelPerBlockHr.toFixed(0)} kg</td></tr>
          <tr><td>Total Cost</td><td>$${formatNumber(totalCost)}</td></tr>
        </table>`;

      // === Chart.js Cost Breakdown ===
      const ctx = document.getElementById('costChart');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Fuel', 'ACMI', 'Navigation'],
          datasets: [{ data: [totalFuelCost, totalAcmi, totalNav], backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56'] }]
        },
        options: { plugins: { title: { display: true, text: 'Cost Breakdown' } } }
      });

      // Map drawing
      routeLayer = L.polyline(latlngs, { color: 'blue' }).addTo(map);
      map.fitBounds(routeLayer.getBounds());
      latlngs.forEach((p, i) => L.marker(p).addTo(map).bindPopup(airports[i]));

      document.getElementById('calculateBtn').classList.add('hidden');
      document.getElementById('queryAgainBtn').classList.remove('hidden');
      saveRoute();
    }

    function resetApp() {
      document.getElementById('result').innerHTML = '';
      document.getElementById('analytics').innerHTML = '';
      document.getElementById('costChart').replaceWith(document.createElement('canvas'));
      document.getElementById('calculateBtn').classList.remove('hidden');
      document.getElementById('queryAgainBtn').classList.add('hidden');
      if (routeLayer) routeLayer.remove();
    }
  </script>
</body>
</html>
