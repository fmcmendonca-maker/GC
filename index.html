<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Cost Calculator v5.03</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    #map { height: 420px; }
    body.dark { background-color: #0b0b0e; color: #e7e7ea; }
    .card { border-radius: 0.75rem; box-shadow: 0 2px 14px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.06); padding: 1rem; }
    .dark .card { border-color:#2a2b35; background-color:#101116; }
    .tbl { width:100%; font-size:0.9rem; border:1px solid rgba(0,0,0,0.08); border-radius:0.5rem; overflow:hidden; }
    .dark .tbl { border-color:#2a2b35; }
    .tbl th { background:#f6f7f9; text-align:left; font-weight:600; padding:0.5rem 0.75rem; white-space:nowrap; }
    .dark .tbl th { background:#1a1b22; }
    .tbl td { padding:0.5rem 0.75rem; border-top:1px solid rgba(0,0,0,0.08); }
    .dark .tbl td { border-top-color:#2a2b35; }
    .tbl tfoot td { font-weight:700; background:#fafafa; }
    .dark .tbl tfoot td { background:#151621; }
  </style>
</head>

<body class="p-4">
  <div class="container mx-auto max-w-7xl space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-3xl font-bold">Multi-Leg Charter Price Calculator <span class="text-sm text-gray-500">v5.03</span></h1>
      <div class="flex items-center gap-3">
        <select id="currency" class="border rounded px-3 py-2">
          <option value="USD" selected>USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="CAD">CAD</option>
        </select>
        <button onclick="toggleTheme()" class="bg-gray-900 text-white px-3 py-2 rounded">Toggle Theme</button>
      </div>
    </header>

    <!-- Input Section -->
    <section class="card space-y-4">
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label for="route" class="font-semibold">Route (e.g. JFK-ORD-LAX)</label>
          <input type="text" id="route" class="w-full border p-2 rounded mt-1" placeholder="Enter route e.g. JFK-ORD-LAX">
        </div>
        <div>
          <label for="aircraft" class="font-semibold">Aircraft Code (e.g. B738, A320)</label>
          <input type="text" id="aircraft" class="w-full border p-2 rounded mt-1" maxlength="5" placeholder="e.g. B738">
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <label for="fuelPrice" class="font-semibold">Fuel Price (USD/kg)</label>
          <input type="number" id="fuelPrice" class="w-full border p-2 rounded mt-1" step="0.01" value="1.07">
        </div>
        <div>
          <label for="acmiRate" class="font-semibold">ACMI Hourly (USD)</label>
          <input type="number" id="acmiRate" class="w-full border p-2 rounded mt-1" step="10">
        </div>
        <div>
          <label for="navRate" class="font-semibold">Navigation Fee (USD/NM)</label>
          <input type="number" id="navRate" class="w-full border p-2 rounded mt-1" step="0.1" value="4">
        </div>
      </div>

      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <label for="landingRate" class="font-semibold">Landing Fee (USD/ton)</label>
          <input type="number" id="landingRate" class="w-full border p-2 rounded mt-1" step="1" value="15">
        </div>
        <div>
          <label for="handlingRate" class="font-semibold">Handling Fee (USD/ton)</label>
          <input type="number" id="handlingRate" class="w-full border p-2 rounded mt-1" step="1" value="10">
        </div>
        <div>
          <label for="groundFee" class="font-semibold">Ground Service (USD/stop)</label>
          <input type="number" id="groundFee" class="w-full border p-2 rounded mt-1" step="10" value="500">
        </div>
      </div>

      <button id="calculateBtn" onclick="calculateFlight()" class="bg-blue-600 text-white px-4 py-2 rounded">Calculate</button>
      <button id="queryAgainBtn" onclick="resetApp()" class="hidden bg-gray-600 text-white px-4 py-2 rounded">New Query</button>
    </section>

    <!-- Results -->
    <section class="card space-y-6">
      <div id="result"></div>
      <canvas id="costChart" class="mt-4"></canvas>
      <div id="map" class="rounded mt-6"></div>
    </section>

    <footer class="text-center text-gray-500 text-sm">
      © Aerohub Version 5.03 — Working Build
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let aircraftInfo = {};
    let map, routeLayer;
    let exchangeRates = { USD: 1 };

    fetch('aircraftData.json')
      .then(res => res.json())
      .then(data => aircraftInfo = data.aircraft)
      .catch(err => alert("Error loading aircraft data: " + err.message));

    async function fetchRates() {
      try {
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await res.json();
        exchangeRates = data.rates;
      } catch {
        exchangeRates = { USD: 1 };
      }
    }
    fetchRates();

    const fixedBlockMinutes = 30;
    const baseFuelPrice = 1.07;
    const formatNumber = num => num.toLocaleString('en-US', { maximumFractionDigits: 0 });
    const formatFlightTime = hours => `${Math.floor(hours)} hr ${Math.round((hours % 1) * 60)} min`;
    function toggleTheme() { document.body.classList.toggle('dark'); }

    async function fetchDistanceWithCoords(origin, destination) {
      const response = await fetch('https://airportgap.com/api/airports/distance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer iHPosKuEeLi2rJHtUNxNJtKo' },
        body: JSON.stringify({ from: origin.toUpperCase(), to: destination.toUpperCase() })
      });
      if (!response.ok) throw new Error('API error: ' + response.statusText);
      return response.json();
    }

    async function calculateFlight() {
      const routeInputVal = document.getElementById('route').value.trim().toUpperCase();
      const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();
      if (!aircraftInfo[aircraftCode]) return alert('Aircraft code not found.');

      const fuelPrice = parseFloat(document.getElementById('fuelPrice').value) || baseFuelPrice;
      const acmiRate = parseFloat(document.getElementById('acmiRate').value) || aircraftInfo[aircraftCode].acmiRate;
      const navRate = parseFloat(document.getElementById('navRate').value);
      const landingRate = parseFloat(document.getElementById('landingRate').value);
      const handlingRate = parseFloat(document.getElementById('handlingRate').value);
      const groundFee = parseFloat(document.getElementById('groundFee').value);
      const airports = routeInputVal.split('-');
      if (airports.length < 2) return alert('Enter at least two airports.');

      const aircraft = aircraftInfo[aircraftCode];
      let totalNM = 0, totalFuelCost = 0, totalAcmi = 0, totalNav = 0;
      let totalLanding = 0, totalHandling = 0, totalGround = 0;
      let totalFuel = 0, totalBlock = 0, totalFlight = 0;
      let warning = false;

      if (!map) {
        map = L.map('map').setView([20,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18}).addTo(map);
      }
      if (routeLayer) routeLayer.remove();

      const latlngs = [];
      let resultHTML = '';

      for (let i = 0; i < airports.length - 1; i++) {
        const from = airports[i];
        const to = airports[i + 1];
        const data = await fetchDistanceWithCoords(from, to);
        const attr = data.data.attributes;
        const nm = attr.nautical_miles;
        const flightTimeHrs = nm / aircraft.speed;
        const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;
        const fuelBurnKg = flightTimeHrs * aircraft.fuelBurnKgPerHr;

        const fuelCost = fuelBurnKg * fuelPrice;
        const acmiCost = blockTimeHrs * acmiRate;
        const navCharge = nm * Math.pow(aircraft.maxTakeoffWeightKg/1000 / 50, 0.7) * navRate;
        const landingFee = (aircraft.maxTakeoffWeightKg/1000) * landingRate;
        const handlingFee = (aircraft.maxTakeoffWeightKg/1000) * handlingRate;
        const groundServiceFee = groundFee;

        totalNM += nm;
        totalFuel += fuelBurnKg;
        totalBlock += blockTimeHrs;
        totalFlight += flightTimeHrs;
        totalFuelCost += fuelCost;
        totalAcmi += acmiCost;
        totalNav += navCharge;
        totalLanding += landingFee;
        totalHandling += handlingFee;
        totalGround += groundServiceFee;
        if (nm > aircraft.maxRangeNM) warning = true;

        latlngs.push([attr.from_airport.latitude, attr.from_airport.longitude]);
        if (i === airports.length - 2) latlngs.push([attr.to_airport.latitude, attr.to_airport.longitude]);
      }

      const totalCost = totalFuelCost + totalAcmi + totalNav + totalLanding + totalHandling + totalGround;
      const selectedCurrency = document.getElementById('currency').value;
      const rate = exchangeRates[selectedCurrency] || 1;
      const conv = val => val * rate;

      resultHTML = `
        <h2 class='text-xl font-semibold mb-2'>Summary</h2>
        <table class='tbl'><tbody>
          <tr><td>Aircraft</td><td>${aircraftCode}</td></tr>
          <tr><td>Total Distance</td><td>${formatNumber(totalNM)} NM</td></tr>
          <tr><td>Total Block Time</td><td>${formatFlightTime(totalBlock)}</td></tr>
          <tr><td>Total Fuel Burn</td><td>${formatNumber(totalFuel)} kg</td></tr>
          <tr><td>Total Cost</td><td>${selectedCurrency} ${formatNumber(conv(totalCost))}</td></tr>
          <tr><td>Warning</td><td>${warning ? 'Leg exceeds range!' : 'None'}</td></tr>
        </tbody></table>
      `;

      document.getElementById('result').innerHTML = resultHTML;

      new Chart(document.getElementById('costChart'), {
        type: 'pie',
        data: {
          labels: ['Fuel', 'ACMI', 'Nav', 'Landing', 'Handling', 'Ground'],
          datasets: [{
            data: [
              conv(totalFuelCost), conv(totalAcmi), conv(totalNav),
              conv(totalLanding), conv(totalHandling), conv(totalGround)
            ]
          }]
        },
        options: { plugins: { title: { display: true, text: 'Cost Breakdown' } } }
      });

      routeLayer = L.polyline(latlngs, { color: 'blue' }).addTo(map);
      map.fitBounds(routeLayer.getBounds());
    }

    function resetApp() {
      document.getElementById('result').innerHTML = '';
      if (routeLayer) routeLayer.remove();
      document.getElementById('calculateBtn').classList.remove('hidden');
      document.getElementById('queryAgainBtn').classList.add('hidden');
    }
  </script>
</body>
</html>
