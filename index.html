<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multi-Leg Flight Calculator</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin: 10px 0 5px; }
  input { padding: 8px; width: 100%; max-width: 400px; }
  button { padding: 10px 15px; margin-top: 10px; }
  table { margin-top: 20px; border-collapse: collapse; width: 100%; max-width: 800px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f5f5f5; }
  .warning { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1>Multi-Leg Flight Distance & Time Calculator</h1>

<label for="route">Route (e.g. JFK-ORD-LAX-MEX):</label>
<input type="text" id="route" placeholder="Enter multi-leg route, e.g. JFK-ORD-LAX-MEX" />

<label for="aircraft">Aircraft Code (e.g. B738, A320):</label>
<input type="text" id="aircraft" maxlength="5" placeholder="e.g. B738" />

<button onclick="calculateFlight()">Calculate</button>

<div id="result"></div>

<script>
const aircraftInfo = {
  B733: { model: "Boeing 737-300", speed: 485, maxRangeNM: 2000 },
  B734: { model: "Boeing 737-400", speed: 485, maxRangeNM: 2300 },
  B735: { model: "Boeing 737-500", speed: 485, maxRangeNM: 1900 },
  B736: { model: "Boeing 737-600", speed: 470, maxRangeNM: 2200 },
  B737: { model: "Boeing 737-700", speed: 485, maxRangeNM: 3150 },
  B738: { model: "Boeing 737-800", speed: 485, maxRangeNM: 2800 },
  B739: { model: "Boeing 737-900", speed: 485, maxRangeNM: 2950 },
  B744: { model: "Boeing 747-400", speed: 560, maxRangeNM: 7280 },
  B748: { model: "Boeing 747-8", speed: 570, maxRangeNM: 8000 },
  B752: { model: "Boeing 757-200", speed: 510, maxRangeNM: 3900 },
  B753: { model: "Boeing 757-300", speed: 510, maxRangeNM: 3650 },
  B762: { model: "Boeing 767-200", speed: 530, maxRangeNM: 3950 },
  B763: { model: "Boeing 767-300", speed: 530, maxRangeNM: 3650 },
  B772: { model: "Boeing 777-200", speed: 560, maxRangeNM: 5235 },
  B773: { model: "Boeing 777-300", speed: 560, maxRangeNM: 4865 },
  B788: { model: "Boeing 787-8", speed: 560, maxRangeNM: 7355 },
  B789: { model: "Boeing 787-9", speed: 560, maxRangeNM: 7600 },
  A318: { model: "Airbus A318", speed: 470, maxRangeNM: 3050 },
  A319: { model: "Airbus A319", speed: 470, maxRangeNM: 3400 },
  A320: { model: "Airbus A320", speed: 510, maxRangeNM: 3300 },
  A321: { model: "Airbus A321", speed: 510, maxRangeNM: 3600 },
  A332: { model: "Airbus A330-200", speed: 515, maxRangeNM: 7400 },
  A333: { model: "Airbus A330-300", speed: 515, maxRangeNM: 6500 },
  A343: { model: "Airbus A340-300", speed: 500, maxRangeNM: 7000 },
  A350: { model: "Airbus A350-900", speed: 560, maxRangeNM: 8100 },
  A388: { model: "Airbus A380", speed: 560, maxRangeNM: 8200 },
  CRJ7: { model: "Bombardier CRJ700", speed: 465, maxRangeNM: 1200 },
  CRJ9: { model: "Bombardier CRJ900", speed: 460, maxRangeNM: 1560 },
  E170: { model: "Embraer E170", speed: 460, maxRangeNM: 1600 },
  E190: { model: "Embraer E190", speed: 460, maxRangeNM: 2400 }
};

const fixedBlockMinutes = 30; // 15 min taxi-out + 15 min taxi-in

function formatFlightTime(hours) {
  const h = Math.floor(hours);
  const m = Math.round((hours - h) * 60);
  return `${h} hr ${m} min`;
}

async function fetchDistance(origin, destination, token) {
  const response = await fetch('https://airportgap.com/api/airports/distance', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer token=' + token
    },
    body: JSON.stringify({ from: origin.toUpperCase(), to: destination.toUpperCase() })
  });

  if (!response.ok) throw new Error('API error: ' + response.statusText);
  return response.json();
}

async function calculateFlight() {
  const routeInput = document.getElementById('route').value.trim().toUpperCase();
  const aircraftCode = document.getElementById('aircraft').value.trim().toUpperCase();
  const token = 'iHPosKuEeLi2rJHtUNxNJtKo'; // Replace with your API token

  if (!aircraftCode || !(aircraftCode in aircraftInfo)) {
    alert('Please enter a valid aircraft code.');
    return;
  }

  const airports = routeInput.split('-');
  if (airports.length < 2) {
    alert('Please enter at least two airports in the route separated by hyphens, e.g. JFK-ORD-LAX');
    return;
  }
  for (let code of airports) {
    if (code.length !== 3) {
      alert('Each airport must be a 3-letter IATA code.');
      return;
    }
  }

  const aircraft = aircraftInfo[aircraftCode];
  let resultHTML = '';
  let totalNM = 0;
  let totalFlightTime = 0;
  let totalBlockTime = 0;
  let warningFlag = false;

  resultHTML += `<table>
  <thead>
    <tr>
      <th>From</th><th>To</th><th>NM</th><th>Flight Time</th><th>Block Time</th><th>Airport Origin</th><th>Airport Destination</th>
    </tr>
  </thead><tbody>`;

  for (let i=0; i<airports.length-1; i++) {
    let fromCode = airports[i];
    let toCode = airports[i+1];

    try {
      const data = await fetchDistance(fromCode, toCode, token);
      const attr = data.data.attributes;
      const nm = attr.nautical_miles;
      const flightTimeHrs = nm / aircraft.speed;
      const blockTimeHrs = flightTimeHrs + fixedBlockMinutes / 60;

      totalNM += nm;
      totalFlightTime += flightTimeHrs;
      totalBlockTime += blockTimeHrs;

      let warningMsg = '';
      if (nm > aircraft.maxRangeNM) {
        warningMsg = `<span class="warning"> &nbsp;âš  Aircraft cannot fly this leg nonstop</span>`;
        warningFlag = true;
      }

      resultHTML += `<tr>
        <td>${fromCode}</td>
        <td>${toCode}</td>
        <td>${nm.toFixed(2)}</td>
        <td>${formatFlightTime(flightTimeHrs)}</td>
        <td>${formatFlightTime(blockTimeHrs)}</td>
        <td>${attr.from_airport.name}, ${attr.from_airport.city}</td>
        <td>${attr.to_airport.name}, ${attr.to_airport.city}</td>
      </tr>`;
    } catch (error) {
      alert('Error fetching data for leg ' + fromCode + ' to ' + toCode + ': ' + error.message);
      return;
    }
  }
  resultHTML += `</tbody></table>`;

  resultHTML += `<p><strong>Total Distance:</strong> ${totalNM.toFixed(2)} NM</p>`;
  resultHTML += `<p><strong>Total Estimated Flight Time (cruise):</strong> ${formatFlightTime(totalFlightTime)}</p>`;
  resultHTML += `<p><strong>Total Estimated Block Time (incl. taxi & ground ops):</strong> ${formatFlightTime(totalBlockTime)}</p>`;

  if (warningFlag) {
    resultHTML += `<p class="warning">One or more legs exceed the maximum range of the aircraft. Please choose another aircraft or plan stopovers.</p>`;
  }

  document.getElementById('result').innerHTML = resultHTML;
}
</script>

</body>
</html>
